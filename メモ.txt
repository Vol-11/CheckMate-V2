// ãƒã‚§ãƒƒã‚¯ç”¨ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡ºï¼ˆä¿®æ­£ç‰ˆï¼‰
async function onCheckDetected(result) {
    const code = result.getText();
    if (!code) return;

    const currentDay = window.currentDay;
    if (!currentDay) {
        console.warn('currentDay is not set');
        return;
    }

    // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
    const checkDate = document.getElementById('check-date-picker').value;

    // é€šå¸¸ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒã‚§ãƒƒã‚¯
    const dayItems = items.filter(i => i.days.includes(currentDay));
    const foundItem = dayItems.find(i => i.code === code);

    // ç‰¹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ãƒã‚§ãƒƒã‚¯
    const override = await getOverride(checkDate);
    const specialItem = override?.added?.find(item => item.code === code);

    if (foundItem) {
        // é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        if (!foundItem.checked) {
            foundItem.checked = true;
            updateItem(foundItem);
            updateStats();
            updateCheckDisplay();

            scanResults.set(code, {
                item: foundItem,
                timestamp: new Date(),
                status: 'checked'
            });

            checkStatusMessage.textContent = `âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†: ${foundItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700';

            showCheckResult(`âœ… ${foundItem.name}`, 'success', 'è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸ');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
        } else {
            checkStatusMessage.textContent = `â„¹ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿: ${foundItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
    } else if (specialItem) {
        // ç‰¹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†
        if (!specialItem.checked) {
            specialItem.checked = true;
            await saveOverride(override);
            updateStats();
            updateCheckDisplay();

            scanResults.set(code, {
                item: specialItem,
                timestamp: new Date(),
                status: 'checked'
            });

            checkStatusMessage.textContent = `âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†: ${specialItem.name} (ç‰¹åˆ¥)`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700';

            showCheckResult(`âœ… ${specialItem.name}`, 'success', 'ã“ã®æ—¥é™å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã§ã™');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
        } else {
            checkStatusMessage.textContent = `â„¹ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿: ${specialItem.name} (ç‰¹åˆ¥)`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
    } else {
        // æ—¢å­˜ã®æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç†
        const anyItem = items.find(i => i.code === code);
        if (anyItem) {
            checkStatusMessage.textContent = `âš ï¸ ${currentDay}æ›œæ—¥ã«ã¯ä¸è¦: ${anyItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            showCheckResult(`âš ï¸ ${anyItem.name}`, 'warning', `${currentDay}æ›œæ—¥ã®ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“`);
        } else {
            checkStatusMessage.textContent = `âŒ æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ : ${code}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700';
            showCheckResult('âŒ æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ ', 'error', `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${code}`);
        }
        if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
    }

    renderScanResults();

    setTimeout(() => {
        checkStatusMessage.textContent = 'ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯';
        checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
        document.getElementById('check-result').classList.add('hidden');
    }, 3000);
}

// ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function showCheckResult(title, type, subtitle) {
    const checkResult = document.getElementById('check-result');
    let bgClass, textClass, borderClass;

    switch(type) {
        case 'success':
            bgClass = 'bg-green-100 dark:bg-green-900/30';
            textClass = 'text-green-700 dark:text-green-300';
            borderClass = 'border-green-300 dark:border-green-700';
            break;
        case 'warning':
            bgClass = 'bg-yellow-100 dark:bg-yellow-900/30';
            textClass = 'text-yellow-700 dark:text-yellow-300';
            borderClass = 'border-yellow-300 dark:border-yellow-700';
            break;
        case 'error':
            bgClass = 'bg-red-100 dark:bg-red-900/30';
            textClass = 'text-red-700 dark:text-red-300';
            borderClass = 'border-red-300 dark:border-red-700';
            break;
    }

    checkResult.className = `p-4 rounded-lg mb-4 text-center font-semibold ${bgClass} ${textClass} border ${borderClass}`;
    checkResult.innerHTML = `
        <div>${title}</div>
        <div class="text-sm mt-1">${subtitle}</div>
    `;
    checkResult.classList.remove('hidden');
}
