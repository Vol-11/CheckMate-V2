# CheckMate v2 アプリケーション設計資料

## 1. 概要

本アプリケーション「CheckMate v2」は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止し、万が一忘れた場合も記録・分析することで、将来の忘れ物を減らすことを目的としています。

## 2. 機能仕様

- **アイテム管理 (CRUD)**
  - アイテムの新規登録、編集、削除が可能。
  - 各アイテムには名前、カテゴリー、重要度、必要な曜日、バーコード、メモを設定可能。
- **クイックアクセス**
  - 主要な統計情報（総アイテム数、チェック済み数、今日のアイテム数）をダッシュボードに表示。
  - アイテム名とカテゴリーのみでの迅速なアイテム登録。
- **チェックリスト機能**
  - 曜日を選択すると、その曜日に必要なアイテムのチェックリストを自動生成。
  - **(改善)** 忘れ物記録に基づき、頻繁に忘れるアイテムはリスト上でハイライト表示され、注意を促す。
  - 手動でのチェック、またはバーコードスキャンによる自動チェックが可能。
  - チェックリストの一括選択、一括解除、リセット機能。
- **忘れ物記録機能**
  - **(改善)** 「忘れ物」タブにその日の持ち物リストが表示され、忘れたアイテムをチェックして記録として保存できる。
  - **(改善)** 記録直後に、間違えた場合のために操作を「元に戻す」機能を追加。
  - 過去の忘れ物を日付ごとに一覧で確認できる。
  - **(改善)** 特定の日付の忘れ物記録を個別に削除できる。
  - **(改善)** 1ヶ月以上前の古い忘れ物記録を一括で削除できる。
  - どのアイテムを何回忘れたか、統計情報を表示する。
- **一覧・検索機能**
  - 全ての登録済みアイテムを一覧表示。
  - カテゴリーやキーワードによる絞り込み検索。
  - 名前、カテゴリー、重要度、登録日による並び替え。
- **データ管理**
  - **(改善)** 全てのデータ（アイテム、カテゴリ、忘れ物履歴）をJSONファイルとしてエクスポート（バックアップ）。
  - **(改善)** JSONファイルから全てのデータをインポート（復元）。
  - **(改善)** 「設定」タブにデータリセット機能を集約。
    - 全アイテムのリセット
    - カテゴリ設定のリセット
    - 忘れ物履歴のリセット
- **PWA対応**
  - ホーム画面へのインストールが可能。
  - オフライン環境でも動作。

## 3. 設計

### 3.1. アーキテクチャ

（変更なし）

### 3.2. データモデル

（変更なし）

### 3.3. 画面構成

UIは6つの主要タブで構成されます。

1.  **クイック**: 主要統計と簡易登録フォームを配置。
2.  **登録**: バーコードスキャナと詳細なアイテム登録フォームを配置。
3.  **一覧**: 全アイテムの検索、フィルタリング、管理を行う。
4.  **チェック**: 曜日別のチェックリスト機能を提供。忘れやすいアイテムのハイライト機能を持つ。
5.  **忘れ物**: **(改善)** デフォルトでその日の忘れ物を記録する画面を表示。過去の記録を閲覧するビューへの切り替えも可能。
6.  **設定**: アプリの統計情報、データ管理機能、PWA情報を提供。

## 4. 主要な処理フロー

### 4.1. アイテムの新規登録フロー

（変更なし）

### 4.2. 忘れ物記録フロー (改善後)

1.  **ユーザー操作**: ユーザーが「忘れ物」タブを開く。
2.  **UI表示**: デフォルトで「今日の忘れ物記録」モードが表示される。その日の曜日にもとづいたアイテムリストがチェックボックス付きで表示される。
3.  **ユーザー操作**: ユーザーが忘れたアイテムのチェックボックスにチェックを入れる。
4.  **ユーザー操作**: ユーザーが「記録を保存」ボタンをクリックする。
5.  **イベント発火**: 「記録を保存」ボタンのクリックイベントリスナーが起動する。
6.  **データ収集**: チェックが入っているアイテムの `id` を収集する。
7.  **データ整形**: 今日の日付 (`YYYY-MM-DD`形式) と、収集した忘れ物アイテムの`id`の配列から、新しい `ForgottenRecord` オブジェクトを生成する。
8.  **DB保存**: `addForgottenRecord` (`js/indexdb.js`) が呼ばれ、生成されたオブジェクトをIndexedDBに保存する。もし同じ日付の記録が既に存在する場合は、上書き更新する。
9.  **UIフィードバック**: ユーザーに「記録しました」といったメッセージを表示し、必要であれば過去の記録一覧ビューに切り替える。

## 5. ファイル別役割詳細

### `js/indexdb.js`
（変更なし）

### `js/items.js`
アイテムのロジックと「一覧」タブの表示を担当する。
- `createItemElement(item, isQuick, forgottenStats)`: **(改善)** 1つのアイテムのHTML要素を生成する。`forgottenStats`（忘れ物統計情報）を受け取り、忘れ物回数が多いアイテムに特定のCSSクラスを付与してハイライトするロジックを追加。
- `renderItems()`: 現在のフィルターやソート順に基づき、アイテム一覧を描画する。
- `addNewItem(itemData)`: フォーム入力から新しいItemオブジェクトを作成し、DB追加処理を呼び出す。
- `getTodayItems()` / `getTomorrowItems()`: 特定の日のアイテムリストを取得するヘルパー関数。

### `js/checklist.js`
「チェック」タブと「クイック」タブ内のチェックリスト表示・操作を担当する。
- `updateCheckDisplay()`: 現在選択されている曜日に基づき、チェックリスト全体を更新する。**(改善)** 忘れ物統計を計算し、`createItemElement`に渡す処理を追加。
- `renderChecklist(day)`: 指定された曜日のチェックリストを手動モードで描画する。
- `renderScanChecklist(day)`: 指定された曜日のチェックリストをスキャンモードで描画する。
- `selectCurrentDay()`: アプリ起動時に今日の曜日に自動で設定する。
- `performCheckAll()` / `performUncheckAll()` / `performResetCheck()`: 一括チェック操作のロジック。
- **(削除)** `saveForgottenItems()`: この機能は`js/forgotten.js`に移管されるため削除。

### `js/forgotten.js` (改善)
「忘れ物」タブの表示とロジックを担当する。
- **(改善)** `initializeForgottenTab()`: 「忘れ物」タブの初期化処理。今日のアイテムリストを描画し、記録保存ボタンのイベントリスナーを設定する。
- **(改善)** `saveTodayForgottenItems()`: 今日の忘れ物リストでチェックされた項目をDBに記録する。
- `renderForgottenHistory()`: DBから過去の忘れ物記録を全て取得し、日付リストと統計情報を描画する（旧`renderForgottenRecords`）。
- UIの表示モード（記録モードと履歴モード）を切り替えるロジック。

### `js/global.js`
（変更なし）

### `js/ui.js`
（変更なし）

### `index.html`
アプリケーションのエントリーポイントであり、全体の初期化処理も含む。
- **(変更)** 「チェック」タブから「忘れ物を記録」ボタンを削除。
- **(変更)** 「忘れ物」タブ内に、記録モードと履歴モードのUI要素を配置。