# 📝 CheckMate V2 アプリケーション設計資料

> **バージョン**: 6 (最新版)
> **最終更新日**: 2025-08-24

---

## 1. 概要

**CheckMate V2**は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止します。

さらに、カレンダー機能による特定日の持ち物管理、忘れ物の記録・分析、PWAによる通知機能などを通じて、将来の忘れ物を減らすことを目的としています。

全てのデータはブラウザ内の**IndexedDB**に保存され、オフラインでも快適に動作します。

## 2. 機能仕様

### 2.1. アイテム管理 (CRUD)

アイテムの新規登録、編集、削除を行います。

- **設定可能な情報**:
  - `名前` (必須)
  - `カテゴリー`
  - `重要度` (必須, 重要, 普通)
  - `必要な曜日` (複数選択可)
  - `バーコード` (任意)
  - `メモ` (任意)

### 2.2. 主要タブの機能

#### 2.2.1. チェックタブ

任意の日付のチェックリストを操作するメイン画面です。

- **日付選択**: 日付ピッカーで対象の日付を自由に選択できます。デフォルトは翌日です。
- **忘れ物ハイライト**:
  - **警告 (黄色)**: 過去に忘れたことがあるアイテム。
  - **危険 (オレンジ色)**: 3回以上忘れたことがあるアイテムには、より目立つ警告が表示されます。
- **チェックモード**:
  - **手動チェック**: チェックボックスをタップしてチェック。
  - **スキャンチェック**: バーコードをスキャンして自動でチェック。
- **一括操作**: 全選択、全解除、チェック状態のリセット。

#### 2.2.2. 日程（カレンダー）タブ

月間カレンダーで持ち物の予定を視覚的に管理します。

- **カレンダー表示**: 持ち物のある日にマークが表示されます。
- **日付ごとの調整**: 特定の日付を選択し、その日だけ持ち物を追加（特別アイテム）したり、曜日設定で決まっている持ち物を一時的に除外したりできます。

#### 2.2.3. 登録タブ

新しいアイテムを登録します。

- **バーコードスキャン**: アイテムのバーコードをスキャンして、コードを簡単に入力できます。
- **詳細入力**: 名前、カテゴリー、重要度、曜日、メモなど、アイテムの詳細情報を設定します。

#### 2.2.4. 一覧タブ

全登録アイテムの管理と検索を行います。

- **一覧表示**: 全ての登録済みアイテムを表示。
- **絞り込み**: カテゴリーやキーワードでリアルタイムにフィルタリング。
- **並び替え**: 名前、カテゴリー、重要度、登録日でソート。

#### 2.2.5. 忘れ物タブ

忘れ物を記録し、傾向を分析します。

- **記録モード**:
  - その日の持ち物リストから、忘れたアイテムをチェックして記録として保存。
  - 操作を間違えた場合のための「元に戻す」機能。
- **履歴・統計モード**:
  - **サマリー**: 総忘れ物回数と記録日数。
  - **忘れ物ワーストランキング**: 忘れ物回数が多い順のアイテムランキング。
  - **カテゴリ別・曜日別グラフ**: 忘れ物の傾向を可視化。
  - **全履歴リスト**: 過去の忘れ物を日付ごとに一覧表示。記録の個別削除も可能。
  - 1ヶ月以上前の古い記録の一括削除機能。

#### 2.2.6. 設定タブ

アプリケーション全体の設定とデータ管理を行います。

- **統計情報**:
  - 総アイテム数、カテゴリ数、バーコード付きアイテム数、完了率など、より詳細な統計を表示。
- **通知設定 (PWA限定)**:
  - 指定した時刻に、翌日の持ち物リストを通知するよう設定できます。
  - 「必須」アイテムや忘れやすいアイテムが未チェックの場合に再通知するオプションもあります。
- **データ管理**:
  - **JSONエクスポート/インポート**: 全データのバックアップと復元。
  - **簡易バックアップ/復元**: LocalStorageを利用した手軽なバックアップ。
  - **データリセット**: 全アイテム、カテゴリ、忘れ物履歴の個別リセット。
- **カテゴリ管理**:
  - 新規カテゴリの追加と削除。
- **PWA**: アプリをホーム画面にインストールするためのボタン。

---

## 3. データモデル (IndexedDB)

- **データベース名**: `wasuremonoPro`
- **バージョン**: `6`

### 3.1. `items` ストア

アイテム情報を格納します。

- **キー**: `id` (auto-increment)
- **主なプロパティ**:
  - `name`: `String`
  - `category`: `String`
  - `priority`: `String`
  - `code`: `String`
  - `memo`: `String`
  - `days`: `Array<String>`
  - `checked`: `Boolean`
  - `createdAt`: `Date`
  - `updatedAt`: `Date`
- **インデックス**: `category`, `name`, `code`

### 3.2. `categories` ストア

ユーザーが作成したカテゴリ情報を格納します。

- **キー**: `id` (タイムスタンプに基づく手動生成)
- **主なプロパティ**: `name`: `String`
- **インデックス**: `name` (unique)

### 3.3. `forgotten_records` ストア

忘れ物記録を格納します。

- **キー**: `date` (YYYY-MM-DD形式の文字列)
- **主なプロパティ**:
  - `date`: `String`
  - `forgottenItems`: `Array<Number>` (アイテムIDの配列)
- **インデックス**: `date_idx` (unique)
- **仕様**: 同一日付の記録は上書きされます。

### 3.4. `date_overrides` ストア

特定の日付の持ち物リストへの変更を格納します。

- **キー**: `date` (YYYY-MM-DD形式の文字列)
- **主なプロパティ**:
  - `date`: `String`
  - `added`: `Array<Object>` (その日だけ追加された特別アイテムの配列)
  - `removed`: `Array<Number>` (その日だけ除外された通常アイテムIDの配列)

---

## 4. バックアップシステム

本アプリは2種類のバックアップ方法を提供します。

### 4.1. JSONファイルによるエクスポート/インポート

完全なデータをファイルとして管理します。

- **エクスポート**: 全てのアイテム、カテゴリ、忘れ物履歴を含むJSONファイルをダウンロードします。
- **インポート**: エクスポートされたJSONファイルを読み込み、現在の全データを上書きして復元します。
- **ファイル構造**:
  ```json
  {
    "version": 3,
    "categories": [
      { "id": "1672531200000", "name": "ドキュメント" }
    ],
    "items": [
      { "id": 1, "name": "PC", "category": "電子機器", ... }
    ],
    "forgottenRecords": [
      { "date": "2023-10-27", "forgottenItems": [1] }
    ],
    "exportedAt": "2023-10-28T00:00:00.000Z",
    "app": "CheckMate-V2"
  }
  ```

### 4.2. LocalStorageによる簡易バックアップ/復元

手軽なバックアップ手段ですが、永続性は保証されません。

- **バックアップ**: 現在の全データをブラウザのLocalStorageに保存します。
- **復元**: LocalStorageに保存されたデータから復元します。
> **注意**: この方法はブラウザのキャッシュクリアなどでデータが失われる可能性があります。重要なデータの保存にはJSONエクスポートを推奨します。

---

## 5. ファイル別役割詳細

### 5.1. `index.html`

アプリケーションの唯一のエントリーポイントであり、UIの骨格を定義します。

- 全てのJavaScriptファイルを読み込みます。
- バーコードスキャンライブラリとして **ZXing-WASM** をCDN経由で読み込みます。
- 主要なイベントリスナー（JSONインポート/エクスポートなど）を直接含みます。

### 5.2. JavaScript (`js/` ディレクトリ)

#### データと状態管理
- `js/indexdb.js`: **データベース層の中核**。IndexedDBのセットアップと、各ストアに対するCRUD操作の非同期関数を全て提供します。
- `js/global.js`: アプリケーション全体で共有されるグローバル変数（`items`配列など）を定義します。

#### UI/UXと主要ロジック
- `js/tab.js`: 主要タブの表示切り替えロジックを管理します。
- `js/items.js`: **アイテム関連の最重要ファイル**。HTML要素生成、一覧描画、アイテム追加ロジック、日付ごとのアイテムリスト取得（`getItemsForDate`）などを担当します。
- `js/checklist.js`: 「チェック」タブのUIとロジックを担当。日付ピッカーの操作や、日付に基づいたチェックリストの表示を行います。
- `js/calendar.js`: **「日程」タブのコア機能**。カレンダーの描画、日付ごとの持ち物オーバーライド（追加・除外）のUIを管理します。
- `js/forgotten.js`: 「忘れ物」タブのUIロジック全体（記録モードと統計モードの切り替え、データ保存、統計描画）を管理します。
- `js/category.js`: カテゴリ管理（追加・削除、プルダウンへの反映）機能を提供します。
- `js/search.js`: 「一覧」タブのリアルタイム検索フィルタリングを処理します。
- `js/sort.js`: 「一覧」タブの並び替えロジックを管理します。
- `js/ui.js`: 編集モーダルの表示・非表示・保存ロジックを管理します。
- `js/status.js`: 画面下部に操作結果（成功、エラー等）を通知する`showStatus`関数を提供します。

#### 統計
- `js/stats.js`: ヘッダーや設定タブに表示される基本統計（総アイテム数など）を計算・更新します。
- `js/stats_util.js`: **高度な統計計算ユーティリティ**。忘れ物回数集計や、忘れ物タブ用の多角的な統計情報生成を提供します。

#### 機能特化
- `js/scan_mode.js`: チェックモード（手動/スキャン）のUI切り替えを管理します。
- `js/backup.js`: LocalStorageによる簡易バックアップ・復元機能を提供します。
- `js/notifications.js`: **PWA通知機能**。設定UIの管理と、Service Workerへの通知スケジュール要求を行います。
- `js/pwa.js`: PWAのインストールプロンプトを制御します。
- `js/dark_mode.js`: ダークモード切り替えボタンのイベントを処理します。
- `js/dark_mode_startup.js`: ページ読み込み時に初期テーマ（ライト/ダーク）を適用します。
- `js/style_config.js`: Tailwind CSSのカスタマイズ設定を定義します。

### 5.3. その他

- `sw.js`: **Service Workerファイル**。リソースのキャッシング戦略を定義し、オフライン動作を実現します。また、**通知のスケジューリングと表示**も担当します。
- `manifest.webmanifest`: PWAのメタデータ（アプリ名、アイコン、テーマカラーなど）を定義するマニフェストファイル。