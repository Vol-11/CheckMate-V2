# CheckMate v2 アプリケーション設計資料

## 1. 概要

本アプリケーション「CheckMate v2」は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止し、万が一忘れた場合も記録・分析することで、将来の忘れ物を減らすことを目的としています。

## 2. 機能仕様

- **アイテム管理 (CRUD)**
  - アイテムの新規登録、編集、削除が可能。
  - 各アイテムには名前、カテゴリー、重要度、必要な曜日、バーコード、メモを設定可能。
- **クイックアクセス**
  - 主要な統計情報（総アイテム数、チェック済み数、今日のアイテム数）をダッシュボードに表示。
  - アイテム名とカテゴリーのみでの迅速なアイテム登録。
- **チェックリスト機能**
  - 曜日を選択すると、その曜日に必要なアイテムのチェックリストを自動生成。
  - 手動でのチェック、またはバーコードスキャンによる自動チェックが可能。
  - チェックリストの一括選択、一括解除、リセット機能。
- **忘れ物記録機能 (新規)**
  - 「チェック」タブで、その日にチェックされなかったアイテム（=忘れ物）を記録として保存。
  - 過去の忘れ物を日付ごとに一覧で確認。
  - どのアイテムを何回忘れたか、統計情報を表示。
- **一覧・検索機能**
  - 全ての登録済みアイテムを一覧表示。
  - カテゴリーやキーワードによる絞り込み検索。
  - 名前、カテゴリー、重要度、登録日による並び替え。
- **データ管理**
  - 全てのデータをJSONファイルとしてエクスポート（バックアップ）。
  - JSONファイルからのインポート（復元）。
  - 全データの初期化。
- **PWA対応**
  - ホーム画面へのインストールが可能。
  - オフライン環境でも動作。

## 3. 設計

### 3.1. アーキテクチャ

本アプリは、サーバーサイドを持たない完全なクライアントサイドアプリケーションです。

- **フロントエンド**: `HTML`, `Tailwind CSS`, `Vanilla JavaScript`
- **データストレージ**: ブラウザの `IndexedDB` を使用し、全てのデータを永続化します。
- **PWA**: `Service Worker` を利用してオフラインキャッシュを提供し、インストール可能なPWAとして機能します。

### 3.2. データモデル

アプリケーションのデータは2種類の中核オブジェクトで構成されます。

#### 3.2.1. `Item` オブジェクト

| プロパティ    | 型      | 説明                                     |
|---------------|---------|------------------------------------------|
| `id`          | Number  | 一意の識別子 (自動採番)                  |
| `name`        | String  | アイテム名 (例: 「数学の教科書」)        |
| `category`    | String  | カテゴリー (例: 「教材」)                |
| `priority`    | String  | 重要度 (「普通」「重要」「必須」)         |
| `code`        | String  | バーコード番号 (任意)                    |
| `memo`        | String  | メモ (任意)                              |
| `days`        | Array   | 必要な曜日 (例: `["月", "水"]`)        |
| `checked`     | Boolean | チェック状態 (true/false)                |
| `createdAt`   | String  | 作成日時 (ISO 8601形式)                  |
| `updatedAt`   | String  | 最終更新日時 (ISO 8601形式)              |

#### 3.2.2. `ForgottenRecord` オブジェクト (新規)

日々の忘れ物記録を保存します。

| プロパティ      | 型      | 説明                                       |
|-----------------|---------|--------------------------------------------|
| `id`            | Number  | 一意の識別子 (自動採番)                    |
| `date`          | String  | 記録日 (例: "2023-10-27")                  |
| `forgottenItems`| Array   | その日に忘れたアイテムの`id`の配列         |

### 3.3. 画面構成

UIは6つの主要タブで構成されます。

1.  **クイック**: 主要統計と簡易登録フォームを配置。
2.  **登録**: バーコードスキャナと詳細なアイテム登録フォームを配置。
3.  **一覧**: 全アイテムの検索、フィルタリング、管理を行う。
4.  **チェック**: 曜日別のチェックリスト機能を提供。
5.  **忘れ物 (新規)**: 過去の忘れ物記録を閲覧する。
6.  **設定**: アプリの統計情報、データ管理機能、PWA情報を提供。

## 4. 主要な処理フロー

### 4.1. アイテムの新規登録フロー

1.  **ユーザー操作**: ユーザーが「登録」タブで詳細を入力し、「詳細登録」ボタンをクリックする。
2.  **イベント発火**: `add-detail` ボタンのクリックイベントリスナーが起動する (`index.html`内)。
3.  **データ整形**: `addNewItem` (`js/items.js`) が呼ばれ、入力値から新しい `Item` オブジェクトを生成する。
4.  **DB保存**: `addItem` (`js/indexdb.js`) が呼ばれ、生成された `Item` オブジェクトをIndexedDBに保存し、自動採番されたIDを返す。
5.  **状態更新**: DB保存成功後、返されたIDを含むアイテムをグローバル変数 `items` (配列) に追加する。
6.  **UI再描画**: `renderItems` (`js/items.js`) や `updateCheckDisplay` (`js/checklist.js`) などの関数が呼ばれ、画面上のアイテム一覧や統計情報を最新の状態に更新する。

### 4.2. 忘れ物記録フロー (新規)

1.  **ユーザー操作**: ユーザーが「チェック」タブでその日の持ち物チェックを終えた後、「忘れ物を記録」ボタンをクリックする。
2.  **イベント発火**: 「忘れ物を記録」ボタンのクリックイベントリスナーが起動する。
3.  **データ収集**: 現在表示されているチェックリストから、`checked`が`false`のアイテム（=忘れ物）を特定する。
4.  **データ整形**: 今日の日付 (`YYYY-MM-DD`形式) と、特定した忘れ物アイテムの`id`の配列から、新しい `ForgottenRecord` オブジェクトを生成する。
5.  **DB保存**: `addForgottenRecord` (`js/indexdb.js`) が呼ばれ、生成されたオブジェクトをIndexedDBに保存する。もし同じ日付の記録が既に存在する場合は、上書き更新する。
6.  **UIフィードバック**: ユーザーに「今日の忘れ物を記録しました」といったメッセージを表示する。

## 5. ファイル別役割詳細

### `js/indexdb.js`
データベース(IndexedDB)に関する全ての処理を担当する。
- `openDB()`: DB接続を初期化し、`items`と`forgotten_records`のテーブル(ObjectStore)を作成する。
- `addItem(item)`: 新しいアイテムをDBに追加する。
- `getAllItems()`: 全てのアイテムをDBから取得する。
- `updateItem(item)`: 既存のアイテムをDB内で更新する。
- `deleteItem(id)`: 指定されたIDのアイテムをDBから削除する。
- `clearItems()`: 全てのアイテムをDBから削除する。
- **(新規)** `addForgottenRecord(record)`: 忘れ物記録を追加または更新する。
- **(新規)** `getAllForgottenRecords()`: 全ての忘れ物記録を取得する。

### `js/items.js`
アイテムのロジックと「一覧」タブの表示を担当する。
- `createItemElement(item, isQuick)`: 1つのアイテムのHTML要素を生成する。UIレイアウトの核。
- `renderItems()`: 現在のフィルターやソート順に基づき、アイテム一覧を描画する。
- `addNewItem(itemData)`: フォーム入力から新しいItemオブジェクトを作成し、DB追加処理を呼び出す。
- `getTodayItems()` / `getTomorrowItems()`: 特定の日のアイテムリストを取得するヘルパー関数。

### `js/checklist.js`
「チェック」タブと「クイック」タブ内のチェックリスト表示・操作を担当する。
- `updateCheckDisplay()`: 現在選択されている曜日に基づき、チェックリスト全体を更新する。
- `renderChecklist(day)`: 指定された曜日のチェックリストを手動モードで描画する。
- `renderScanChecklist(day)`: 指定された曜日のチェックリストをスキャンモードで描画する。
- `selectCurrentDay()`: アプリ起動時に今日の曜日に自動で設定する。
- `performCheckAll()` / `performUncheckAll()` / `performResetCheck()`: 一括チェック操作のロジック。
- **(新規)** `saveForgottenItems()`: チェックリスト内の未チェック項目を忘れ物としてDBに記録する処理を呼び出す。

### `js/forgotten.js` (新規)
「忘れ物」タブの表示とロジックを担当する。
- `renderForgottenRecords()`: DBから忘れ物記録を全て取得し、日付リストと統計情報を描画する。
- `showForgottenItemsForDate(date)`: 特定の日付の忘れ物アイテム詳細を表示する。

### `js/global.js`
アプリケーション全体で利用されるグローバル変数を定義する。
- `items`: 全アイテムを保持する配列。DBから読み込まれ、アプリ動作中のマスターデータとなる。
- `categories`: 全カテゴリを保持する配列。
- `currentDay`, `currentCategory`, `sortBy`: UIの状態を保持する変数。

### `js/ui.js`
タブ切り替えやモーダル表示など、UI全般の制御を担当する。
- `openEditModal(item)` / `closeEditModal()`: 編集モーダルの表示/非表示を制御する。

### `index.html`
アプリケーションのエントリーポイントであり、全体の初期化処理も含む。
- `(DOMContentLoaded)`: `openDB()` を呼び出してDB接続を開始し、`loadItems()`で初期データを読み込む。
- 各種ボタンのイベントリスナーを登録する。
