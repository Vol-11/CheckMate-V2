# CheckMate v2 アプリケーション設計資料 (最新版)

## 1. 概要

本アプリケーション「CheckMate v2」は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止します。さらに、万が一忘れた場合も記録・分析し、その結果を多角的に可視化することで、将来の忘れ物を減らすことを目的としています。

全てのデータはブラウザ内のIndexedDBに保存され、オフラインでも動作します。

## 2. 機能仕様

### アイテム管理 (CRUD)
- アイテムの新規登録、編集、削除。
- 各アイテムには以下の情報を設定可能：
  - **名前** (必須)
  - **カテゴリー**
  - **重要度** (必須, 重要, 普通)
  - **必要な曜日** (複数選択可)
  - **バーコード** (任意)
  - **メモ** (任意)

### クイックアクセスタブ
- ヘッダーに主要な統計情報（総アイテム数、チェック済み数、今日のアイテム数）を常時表示。
- アイテム名とカテゴリーのみでの迅速なアイテム登録。
- 今日のチェックリストと明日のチェックリストを個別に表示。

### チェックリストタブ
- 曜日を選択すると、その曜日に必要なアイテムのチェックリストを自動生成。
- **忘れ物ハイライト**: 過去の忘れ物記録に基づき、頻繁に忘れるアイテム（3回以上）や忘れ物履歴のあるアイテムをリスト上でハイライト表示し、注意を喚起。
- **チェックモード**:
  - **手動チェック**: チェックボックスをタップしてチェック。
  - **スキャンチェック**: バーコードをスキャンして自動でチェック。
- チェックリストの一括選択、一括解除、全アイテムのチェック状態リセット機能。

### 忘れ物記録と統計タブ
- **記録モード**: その日の持ち物リストが表示され、忘れたアイテムをチェックして記録として保存。
  - 記録直後に、間違えた場合のために操作を「元に戻す」機能を提供。
- **履歴・統計モード**: 過去の忘れ物記録を多角的に分析・可視化。
  - **サマリー**: 総忘れ物回数と記録日数を表示。
  - **忘れ物ワーストランキング**: 忘れ物回数が多い順に全アイテムをランキング表示。
  - **カテゴリ別棒グラフ**: カテゴリごとの忘れ物回数を棒グラフで可視化。
  - **曜日別棒グラフ**: 曜日ごとの忘れ物回数を棒グラフで可視化。
  - **全履歴リスト**: 過去の忘れ物を日付ごとに一覧で確認でき、特定の日付の記録を個別に削除可能。
  - 1ヶ月以上前の古い忘れ物記録を一括で削除する機能。

### 一覧・検索タブ
- 全ての登録済みアイテムを一覧表示。
- カテゴリーやキーワードによる絞り込み検索。
- 名前、カテゴリー、重要度、登録日による並び替え機能。

### 設定タブ
- **統計情報**: アプリケーションのより詳細な統計情報（総アイテム数、カテゴリ数、バーコード付きアイテム数、完了率）を表示。
- **データ管理**:
  - **JSONエクスポート**: 全てのデータ（アイテム、カテゴリ、忘れ物履歴）をJSONファイルとしてバックアップ。
  - **JSONインポート**: バックアップしたJSONファイルから全てのデータを復元。
  - **簡易バックアップ/復元**: LocalStorageを利用した簡易的なバックアップと復元。
  - **データリセット**: 全アイテム、カテゴリ設定、忘れ物履歴を個別にリセットする機能。
- **カテゴリ管理**:
  - 新しいカテゴリの追加。
  - 既存カテゴリの削除（ただし、そのカテゴリを使用しているアイテムが存在しない場合のみ）。
- **PWA**: アプリをホーム画面にインストールするためのボタンを表示。

## 3. データモデル (IndexedDB)

- **データベース名**: `wasuremonoPro`
- **バージョン**: 5

### `items` ストア
アイテム情報を格納します。
- **キー**: `id` (auto-increment)
- **主なプロパティ**: `name`, `category`, `priority`, `code`, `memo`, `days`, `checked`, `createdAt`, `updatedAt`
- **インデックス**: `category`, `name`, `code`

### `categories` ストア
ユーザーが作成したカテゴリ情報を格納します。
- **キー**: `id` (タイムスタンプに基づく手動生成)
- **主なプロパティ**: `name`
- **インデックス**: `name` (unique)

### `forgotten_records` ストア
忘れ物記録を格納します。
- **キー**: `date` (YYYY-MM-DD形式の文字列)
- **主なプロパティ**: `date`, `forgottenItems` (アイテムIDの配列)
- **インデックス**: `date_idx` (unique)
- **仕様**: 同一日付の記録は上書きされます。

## 4. バックアップシステム

本アプリは2種類のバックアップ方法を提供します。

### JSONファイルによるエクスポート/インポート
- **エクスポート**: 全てのアイテム、カテゴリ、忘れ物履歴を含む完全なデータを一つのJSONファイルとしてダウンロードします。
- **インポート**: エクスポートされたJSONファイルを読み込み、現在の全データを上書きして復元します。
- **ファイル構造**:
  ```json
  {
    "version": 3,
    "categories": [ ... ],
    "items": [ ... ],
    "forgottenRecords": [ ... ],
    "exportedAt": "ISO形式の日時文字列",
    "app": "CheckMate-V2"
  }
  ```

### LocalStorageによる簡易バックアップ/復元
- **バックアップ**: 現在の全データをブラウザのLocalStorageに保存します。手軽ですが、ブラウザのキャッシュクリアなどで失われる可能性があります。
- **復元**: LocalStorageに保存されたデータから復元します。

## 5. ファイル別役割詳細

### `index.html`
- アプリケーションの唯一のエントリーポイント。全てのUI要素の骨格を定義。
- 全てのJavaScriptファイルを読み込む。
- JSONインポート/エクスポートやアイテムの新規登録など、一部の主要なイベントリスナーを直接含んでいる。

### JavaScript (`js/` ディレクトリ)

#### データと状態管理
- `js/indexdb.js`: IndexedDBのセットアップと接続(`openDB`)。`items`, `categories`, `forgotten_records`の各ストアに対するCRUD（作成、読取、更新、削除）操作の非同期関数を全て提供する、データベース層の中核。
- `js/global.js`: `items`や`categories`の配列、現在のソート順(`sortBy`)など、アプリケーション全体で共有されるグローバル変数を定義。

#### UI/UXと主要ロジック
- `js/tab.js`: 画面上部の主要タブ（クイック, 登録, 一覧など）の表示切り替えロジックを管理。
- `js/items.js`: アイテム関連の最も中心的なファイル。
  - `createItemElement()`: 1つのアイテムのHTML要素を動的に生成する。チェック状態や忘れ物回数に応じてスタイルを変更するロジックも含む。
  - `renderItems()`: 現在のフィルターやソート順に基づき、「一覧」タブのアイテム一覧を描画する。
  - `addNewItem()`: 新規アイテムをDBに追加するためのコアロジック。
- `js/checklist.js`: 「チェック」タブと「クイック」タブ内のチェックリスト表示・操作を担当。曜日選択、進捗表示、一括チェック操作など。
- `js/forgotten.js`: 「忘れ物」タブのUIロジック全体を管理。記録モードと履歴・統計モードの切り替え、忘れ物データの保存、統計情報の描画を行う。
- `js/quick.js`: 「クイック」タブでの簡易アイテム追加機能を提供。
- `js/category.js`: カテゴリ管理機能を提供。設定タブでのカテゴリ追加・削除、各種プルダウンメニューへのカテゴリ反映など。
- `js/search.js`: 「一覧」タブの検索ボックスの入力イベントを処理し、リアルタイムに一覧をフィルタリングする。
- `js/sort.js`: 「一覧」タブの並び替えボタンのロジックを管理。
- `js/ui.js`: 主に編集モーダルの表示・非表示・保存ロジックを管理する。
- `js/status.js`: 画面下部に操作結果（成功、エラー等）を一時的に表示する`showStatus`関数を提供。

#### 統計
- `js/stats.js`: ヘッダーや設定タブに表示される基本的な統計情報（総アイテム数など）を計算・更新する。
- `js/stats_util.js`: より高度な統計計算のためのユーティリティ関数を提供。
  - `getForgottenItemStats()`: アイテムごとの忘れ物回数を集計し、チェックリストのハイライト表示に使用される。
  - `getForgottenStats()`: DBから全履歴を取得し、「忘れ物」タブで表示するための多角的な統計情報（ランキング、グラフデータ等）を一つのオブジェクトにまとめて返す。

#### 機能特化
- `js/scan_mode.js`: 「チェック」タブ内での手動モードとスキャンモードのUI切り替えを管理。
- `js/backup.js`: LocalStorageを利用した簡易バックアップ・復元機能のロジックを提供。
- `js/pwa.js`: PWAのインストールプロンプトを制御する。
- `js/dark_mode.js`: ダークモードの切り替えボタンのイベントを処理する。
- `js/dark_mode_startup.js`: ページ読み込み時に、LocalStorageやOSの設定に基づいて初期テーマ（ライト/ダーク）を適用する。
- `js/style_config.js`: Tailwind CSSのカスタマイズ設定を定義。

### その他
- `sw.js`: Service Workerファイル。オフライン動作を実現するために、リソースのキャッシング戦略を定義している。
- `manifest.webmanifest`: PWAのメタデータ（アプリ名、アイコン、テーマカラーなど）を定義するマニフェストファイル。
