# CheckMate v2 アプリケーション設計資料

## 1. 概要

本アプリケーション「CheckMate v2」は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止し、万が一忘れた場合も記録・分析することで、将来の忘れ物を減らすことを目的としています。

## 2. 機能仕様

- **アイテム管理 (CRUD)**
  - アイテムの新規登録、編集、削除が可能。
  - 各アイテムには名前、カテゴリー、重要度、必要な曜日、バーコード、メモを設定可能。
- **クイックアクセス**
  - 主要な統計情報（総アイテム数、チェック済み数、今日のアイテム数）をダッシュボードに表示。
  - アイテム名とカテゴリーのみでの迅速なアイテム登録。
- **チェックリスト機能**
  - 曜日を選択すると、その曜日に必要なアイテムのチェックリストを自動生成。
  - **(改善)** 忘れ物記録に基づき、頻繁に忘れるアイテムはリスト上でハイライト表示され、注意を促す。
  - 手動でのチェック、またはバーコードスキャンによる自動チェックが可能。
  - チェックリストの一括選択、一括解除、リセット機能。
- **忘れ物記録機能**
  - **(改善)** 「忘れ物」タブにその日の持ち物リストが表示され、忘れたアイテムをチェックして記録として保存できる。
  - **(改善)** 記録直後に、間違えた場合のために操作を「元に戻す」機能を追加。
  - 過去の忘れ物を日付ごとに一覧で確認できる。
  - **(改善)** 特定の日付の忘れ物記録を個別に削除できる。
  - **(改善)** 1ヶ月以上前の古い忘れ物記録を一括で削除できる。
  - どのアイテムを何回忘れたか、統計情報を表示する。
- **一覧・検索機能**
  - 全ての登録済みアイテムを一覧表示。
  - カテゴリーやキーワードによる絞り込み検索。
  - 名前、カテゴリー、重要度、登録日による並び替え。
- **データ管理**
  - **(改善)** 全てのデータ（アイテム、カテゴリ、忘れ物履歴）をJSONファイルとしてエクスポート（バックアップ）。
  - **(改善)** JSONファイルから全てのデータをインポート（復元）。
  - **(改善)** 「設定」タブにデータリセット機能を集約。
    - 全アイテムのリセット
    - カテゴリ設定のリセット
    - 忘れ物履歴のリセット
- **PWA対応**
  - ホーム画面へのインストールが可能。
  - オフライン環境でも動作。

## 3. 設計

### 3.1. アーキテクチャ

（変更なし）

### 3.2. データモデル

（変更なし）

### 3.3. 画面構成

UIは6つの主要タブで構成されます。

1.  **クイック**: 主要統計と簡易登録フォームを配置。
2.  **登録**: バーコードスキャナと詳細なアイテム登録フォームを配置。
3.  **一覧**: 全アイテムの検索、フィルタリング、管理を行う。
4.  **チェック**: 曜日別のチェックリスト機能を提供。忘れやすいアイテムのハイライト機能を持つ。
5.  **'''# CheckMate v2 アプリケーション設計資料 (最新版)

## 1. 概要

本アプリケーション「CheckMate v2」は、学生やプロフェッショナルが日々の持ち物を忘れずに管理するためのプログレッシブウェブアプリ（PWA）です。曜日ごとに必要なアイテムを登録し、日々のチェックリストを自動生成することで、忘れ物を防止します。さらに、万が一忘れた場合も記録・分析し、その結果を可視化することで、将来の忘れ物を減らすことを目的としています。

## 2. 機能仕様

- **アイテム管理 (CRUD)**
  - アイテムの新規登録、編集、削除。
  - 各アイテムには名前、カテゴリー、重要度、必要な曜日、バーコード、メモを設定可能。
- **クイックアクセス**
  - 主要な統計情報（総アイテム数、チェック済み数、今日のアイテム数）をダッシュボードに表示。
  - アイテム名とカテゴリーのみでの迅速なアイテム登録。
- **チェックリスト機能**
  - 曜日を選択すると、その曜日に必要なアイテムのチェックリストを自動生成。
  - 忘れ物記録に基づき、頻繁に忘れるアイテムはリスト上でハイライト表示され、注意を促す。
  - 手動でのチェック、またはバーコードスキャンによる自動チェックが可能。
  - チェックリストの一括選択、一括解除、リセット機能。
- **忘れ物記録と統計機能**
  - 「忘れ物」タブでその日の忘れ物をチェックし、記録として保存できる。
  - 記録直後に、間違えた場合のために操作を「元に戻す」機能を提供。
  - **(新規)** 過去の忘れ物記録を多角的に分析・可視化する統計表示機能:
    - **サマリー**: 総忘れ物回数と記録日数を表示。
    - **忘れ物ワーストランキング**: 忘れ物回数が多い順に全アイテムをランキング表示。
    - **カテゴリ別棒グラフ**: カテゴリごとの忘れ物回数を棒グラフで可視化。
    - **曜日別棒グラフ**: 曜日ごとの忘れ物回数を棒グラフで可視化。
  - 過去の忘れ物を日付ごとに一覧で確認できる。
  - 特定の日付の忘れ物記録を個別に削除できる。
  - 1ヶ月以上前の古い忘れ物記録を一括で削除できる。
- **一覧・検索機能**
  - 全ての登録済みアイテムを一覧表示。
  - カテゴリーやキーワードによる絞り込み検索。
  - 名前、カテゴリー、重要度、登録日による並び替え。
- **データ管理**
  - 全てのデータ（アイテム、カテゴリ、忘れ物履歴）をJSONファイルとしてエクスポート（バックアップ）。
  - JSONファイルから全てのデータをインポート（復元）。
  - 「設定」タブにデータリセット機能を集約（全アイテム、カテゴリ、忘れ物履歴）。
- **PWA対応**
  - ホーム画面へのインストール、オフライン動作。

## 3. 設計

### 3.1. データモデル (IndexedDB)
- **`items`ストア**: アイテム情報を格納。(`id` auto-increment)
- **`categories`ストア**: カテゴリ情報を格納。(`id` 手動生成)
- **`forgotten_records`ストア**: 忘れ物記録を格納。(`date` YYYY-MM-DD形式がキー。同一日付は上書き)

### 3.2. 画面構成
UIは6つの主要タブで構成される。

1.  **クイック**: 主要統計と簡易登録フォーム。
2.  **登録**: バーコードスキャナと詳細なアイテム登録フォーム。
3.  **一覧**: 全アイテムの検索、フィルタリング、管理。
4.  **チェック**: 曜日別のチェックリスト機能。忘れやすいアイテムのハイライト機能を持つ。
5.  **忘れ物**: 「記録」モードと「履歴」モードを持つ。
    - **記録モード**: その日の忘れ物をチェックして保存する。
    - **履歴モード**: **(改善)** 詳細な統計情報（ランキング、グラフ）と、過去の全履歴リストを表示する。
6.  **設定**: アプリの統計情報、データ管理機能（インポート/エクスポート/リセット）、PWA情報。

## 4. ファイル別役割詳細

### `js/indexdb.js`
- IndexedDBのセットアップと接続 (`openDB`)。
- `items`, `categories`, `forgotten_records` の各ストアに対するCRUD（作成、読み取り、更新、削除）操作の非同期関数を提供。
- `forgotten_records`ストアは日付文字列 (`YYYY-MM-DD`) をキーとしており、`put`操作により同一日付の記録は上書きされる仕様。

### `js/items.js`
- アイテムのロジックと「一覧」タブのUIを担当。
- `createItemElement(item, isQuick, forgottenStats)`: 1つのアイテムのHTML要素を生成する。`forgottenStats`（忘れ物統計）を受け取り、忘れ物回数が多いアイテムにハイライト用のCSSクラス (`is-forgotten-frequently`) を付与する。
- `renderItems()`: 現在のフィルターやソート順に基づき、アイテム一覧を描画する。
- `addNewItem(itemData)`: フォーム入力から新しいItemオブジェクトを作成し、DB追加処理を呼び出す。

### `js/checklist.js`
- 「チェック」タブと「クイック」タブ内のチェックリスト表示・操作を担当。
- `updateCheckDisplay()`: 選択された曜日に基づきチェックリストを更新する際、`getForgottenItemStats` を呼び出して忘れ物統計を取得し、`createItemElement` に渡すことで、忘れやすいアイテムのハイライトを実現する。
- `renderChecklist(day)` / `renderScanChecklist(day)`: 各モードのチェックリストを描画する。

### `js/forgotten.js` (大幅改善)
- 「忘れ物」タブのUIロジック全体を管理。
- `switchForgottenMode(mode)`: 「記録」モードと「履歴」モードの表示を切り替える。
- `renderForgottenRecordingMode()`: 今日の持ち物リストを記録用に描画する。
- `saveTodayForgottenItems()`: チェックされた忘れ物をDBに保存する。
- `renderForgottenHistoryMode()`: **(改善)** 忘れ物履歴がある場合に `getForgottenStats` を呼び出し、その結果を用いて統計サマリー、アイテム別ランキング、カテゴリ別・曜日別の棒グラフを動的に生成して表示する。また、過去の全履歴を日付ごとにリスト表示する。

### `js/stats_util.js` (重要)
- 高度な統計計算のためのユーティリティ関数を提供。
- `getForgottenItemStats()`: アイテムごとの忘れ物回数を集計したシンプルなオブジェクトを返す。
- `getForgottenStats()`: DBから全履歴を取得し、多角的な統計情報を一つのオブジェクトにまとめて返す。戻り値の構造は以下の通り:
  ```javascript
  {
    totalRecords: Number,       // 記録のある日数
    totalForgottenItems: Number, // 全忘れ物アイテムの延べ数
    byItem: { itemId: { name, category, count } }, // アイテム別集計
    byCategory: { categoryName: { count, items: { itemId: count } } }, // カテゴリ別集計
    byDayOfWeek: { '月': Number, ... }, // 曜日別集計
    byDate: { 'YYYY-MM-DD': Number, ... } // 日付別集計
  }
  ```

### `js/stats.js`
- アプリケーションの基本的な統計情報を更新する。
- `updateStats()`: ヘッダー部分のクイック統計（総アイテム数、チェック済み数、今日のアイテム数）を更新する。
- `updateDetailedStats()`: 「設定」タブ内の詳細統計（カテゴリ数、バーコード付きアイテム数など）を更新する。

### `js/global.js`, `js/ui.js`, `js/tab.js`, etc.
- それぞれ、グローバル変数・関数、共通UI処理（モーダル、トースト表示）、タブ切り替えロジックなど、アプリケーションの基本的な動作を支える役割を持つ。
'''
6.  **設定**: アプリの統計情報、データ管理機能、PWA情報を提供。

## 4. 主要な処理フロー

### 4.1. アイテムの新規登録フロー

（変更なし）

### 4.2. 忘れ物記録フロー (改善後)

1.  **ユーザー操作**: ユーザーが「忘れ物」タブを開く。
2.  **UI表示**: デフォルトで「今日の忘れ物記録」モードが表示される。その日の曜日にもとづいたアイテムリストがチェックボックス付きで表示される。
3.  **ユーザー操作**: ユーザーが忘れたアイテムのチェックボックスにチェックを入れる。
4.  **ユーザー操作**: ユーザーが「記録を保存」ボタンをクリックする。
5.  **イベント発火**: 「記録を保存」ボタンのクリックイベントリスナーが起動する。
6.  **データ収集**: チェックが入っているアイテムの `id` を収集する。
7.  **データ整形**: 今日の日付 (`YYYY-MM-DD`形式) と、収集した忘れ物アイテムの`id`の配列から、新しい `ForgottenRecord` オブジェクトを生成する。
8.  **DB保存**: `addForgottenRecord` (`js/indexdb.js`) が呼ばれ、生成されたオブジェクトをIndexedDBに保存する。もし同じ日付の記録が既に存在する場合は、上書き更新する。
9.  **UIフィードバック**: ユーザーに「記録しました」といったメッセージを表示し、必要であれば過去の記録一覧ビューに切り替える。

## 5. ファイル別役割詳細

### `js/indexdb.js`
（変更なし）

### `js/items.js`
アイテムのロジックと「一覧」タブの表示を担当する。
- `createItemElement(item, isQuick, forgottenStats)`: **(改善)** 1つのアイテムのHTML要素を生成する。`forgottenStats`（忘れ物統計情報）を受け取り、忘れ物回数が多いアイテムに特定のCSSクラスを付与してハイライトするロジックを追加。
- `renderItems()`: 現在のフィルターやソート順に基づき、アイテム一覧を描画する。
- `addNewItem(itemData)`: フォーム入力から新しいItemオブジェクトを作成し、DB追加処理を呼び出す。
- `getTodayItems()` / `getTomorrowItems()`: 特定の日のアイテムリストを取得するヘルパー関数。

### `js/checklist.js`
「チェック」タブと「クイック」タブ内のチェックリスト表示・操作を担当する。
- `updateCheckDisplay()`: 現在選択されている曜日に基づき、チェックリスト全体を更新する。**(改善)** 忘れ物統計を計算し、`createItemElement`に渡す処理を追加。
- `renderChecklist(day)`: 指定された曜日のチェックリストを手動モードで描画する。
- `renderScanChecklist(day)`: 指定された曜日のチェックリストをスキャンモードで描画する。
- `selectCurrentDay()`: アプリ起動時に今日の曜日に自動で設定する。
- `performCheckAll()` / `performUncheckAll()` / `performResetCheck()`: 一括チェック操作のロジック。
- **(削除)** `saveForgottenItems()`: この機能は`js/forgotten.js`に移管されるため削除。

### `js/forgotten.js` (改善)
「忘れ物」タブの表示とロジックを担当する。
- **(改善)** `initializeForgottenTab()`: 「忘れ物」タブの初期化処理。今日のアイテムリストを描画し、記録保存ボタンのイベントリスナーを設定する。
- **(改善)** `saveTodayForgottenItems()`: 今日の忘れ物リストでチェックされた項目をDBに記録する。
- `renderForgottenHistory()`: DBから過去の忘れ物記録を全て取得し、日付リストと統計情報を描画する（旧`renderForgottenRecords`）。
- UIの表示モード（記録モードと履歴モード）を切り替えるロジック。

### `js/global.js`
（変更なし）

### `js/ui.js`
（変更なし）

### `index.html`
アプリケーションのエントリーポイントであり、全体の初期化処理も含む。
- **(変更)** 「チェック」タブから「忘れ物を記録」ボタンを削除。
- **(変更)** 「忘れ物」タブ内に、記録モードと履歴モードのUI要素を配置。