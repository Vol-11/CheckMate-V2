<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quagga vs Quagga2 ベンチマーク</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            Quagga vs Quagga2 ベンチマーク
        </h1>
        
        <!-- 設定パネル -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">設定</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- ライブラリ選択 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ライブラリ
                    </label>
                    <select id="librarySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="quagga">Quagga (v0.12.1)</option>
                        <option value="quagga2">Quagga2</option>
                    </select>
                </div>
                
                <!-- 解像度選択 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        解像度
                    </label>
                    <select id="resolutionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="640x480">640x480</option>
                        <option value="800x600">800x600</option>
                        <option value="1280x720">1280x720 (HD)</option>
                        <option value="1920x1080">1920x1080 (FHD)</option>
                    </select>
                </div>
                
                <!-- バーコードタイプ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        バーコードタイプ
                    </label>
                    <select id="barcodeType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="code_128">Code 128</option>
                        <option value="ean_13">EAN-13</option>
                        <option value="ean_8">EAN-8</option>
                        <option value="code_39">Code 39</option>
                    </select>
                </div>
                
                <!-- カメラ選択 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        カメラ
                    </label>
                    <select id="cameraSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">カメラを検出中...</option>
                    </select>
                </div>
            </div>
            
            <!-- 操作ボタン -->
            <div class="flex flex-wrap gap-4">
                <button id="startCamera" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition duration-200">
                    カメラ開始
                </button>
                <button id="stopCamera" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition duration-200" disabled>
                    カメラ停止
                </button>
                <button id="scanBarcode" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition duration-200" disabled>
                    スキャン実行
                </button>
                <button id="resetResults" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                    結果リセット
                </button>
            </div>
        </div>
        
        <!-- カメラプレビュー -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">カメラプレビュー</h2>
            <div id="scanner-container" class="flex justify-center">
                <div id="interactive" class="viewport border-2 border-gray-300 rounded-lg overflow-hidden" 
                     style="max-width: 100%; height: 400px; position: relative;">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        カメラを開始してください
                    </div>
                </div>
            </div>
            <div id="result" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="font-semibold text-lg mb-2">スキャン結果:</h3>
                <p id="resultText" class="text-green-600 font-mono"></p>
            </div>
        </div>
        
        <!-- ベンチマーク結果 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ベンチマーク結果</h2>
            
            <!-- 現在の測定値 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">カメラ起動時間</h3>
                    <p id="cameraStartTime" class="text-2xl font-bold text-blue-600">-- ms</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800 mb-2">スキャン認識時間</h3>
                    <p id="scanTime" class="text-2xl font-bold text-green-600">-- ms</p>
                </div>
            </div>
            
            <!-- 測定履歴テーブル -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-2 text-left">No.</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">ライブラリ</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">解像度</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">カメラ起動時間</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">スキャン時間</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">結果</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">時刻</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="7" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                まだ測定結果がありません
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 統計情報 -->
            <div id="statsSection" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-800 mb-2">平均カメラ起動時間</h3>
                    <p id="avgCameraTime" class="text-xl font-bold text-yellow-600">-- ms</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800 mb-2">平均スキャン時間</h3>
                    <p id="avgScanTime" class="text-xl font-bold text-purple-600">-- ms</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        class QuaggaBenchmark {
            constructor() {
                this.isScanning = false;
                this.currentLibrary = 'quagga';
                this.measurements = [];
                this.cameraStartTime = 0;
                this.scanStartTime = 0;
                this.availableCameras = [];
                this.currentQuaggaInstance = null;
                
                this.initializeElements();
                this.attachEventListeners();
                this.enumerateCameras();
            }
            
            initializeElements() {
                this.librarySelect = document.getElementById('librarySelect');
                this.resolutionSelect = document.getElementById('resolutionSelect');
                this.barcodeType = document.getElementById('barcodeType');
                this.cameraSelect = document.getElementById('cameraSelect');
                this.startCameraBtn = document.getElementById('startCamera');
                this.stopCameraBtn = document.getElementById('stopCamera');
                this.scanBarcodeBtn = document.getElementById('scanBarcode');
                this.resetResultsBtn = document.getElementById('resetResults');
                this.cameraStartTimeEl = document.getElementById('cameraStartTime');
                this.scanTimeEl = document.getElementById('scanTime');
                this.resultEl = document.getElementById('result');
                this.resultTextEl = document.getElementById('resultText');
                this.resultsTableBody = document.getElementById('resultsTableBody');
                this.statsSection = document.getElementById('statsSection');
                this.avgCameraTime = document.getElementById('avgCameraTime');
                this.avgScanTime = document.getElementById('avgScanTime');
            }
            
            attachEventListeners() {
                this.startCameraBtn.addEventListener('click', () => this.startCamera());
                this.stopCameraBtn.addEventListener('click', () => this.stopCamera());
                this.scanBarcodeBtn.addEventListener('click', () => this.performScan());
                this.resetResultsBtn.addEventListener('click', () => this.resetResults());
                this.librarySelect.addEventListener('change', () => this.updateLibrary());
            }
            
            async enumerateCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.availableCameras = devices.filter(device => device.kind === 'videoinput');
                    
                    this.cameraSelect.innerHTML = '';
                    
                    if (this.availableCameras.length === 0) {
                        this.cameraSelect.innerHTML = '<option value="">カメラが見つかりません</option>';
                        return;
                    }
                    
                    this.availableCameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = camera.label || `カメラ ${index + 1}`;
                        this.cameraSelect.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('カメラの列挙に失敗:', error);
                    this.cameraSelect.innerHTML = '<option value="">カメラの検出に失敗</option>';
                }
            }
            
            updateLibrary() {
                this.currentLibrary = this.librarySelect.value;
                if (this.isScanning) {
                    this.stopCamera();
                }
            }
            
            getResolution() {
                const resolution = this.resolutionSelect.value;
                const [width, height] = resolution.split('x').map(Number);
                return { width, height };
            }
            
            getQuaggaInstance() {
                if (this.currentLibrary === 'quagga2') {
                    return window.Quagga2 || window.Quagga;
                }
                return window.Quagga;
            }
            
            async startCamera() {
                const startTime = performance.now();
                this.cameraStartTime = startTime;
                
                try {
                    const resolution = this.getResolution();
                    const QuaggaLib = this.getQuaggaInstance();
                    this.currentQuaggaInstance = QuaggaLib;
                    
                    // 既存のスキャナーを停止
                    if (this.isScanning) {
                        this.stopCamera();
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    const constraints = {
                        width: { min: resolution.width, ideal: resolution.width },
                        height: { min: resolution.height, ideal: resolution.height },
                        facingMode: "environment"
                    };
                    
                    // カメラが選択されている場合はdeviceIdを追加
                    if (this.cameraSelect.value) {
                        constraints.deviceId = { exact: this.cameraSelect.value };
                    }
                    
                    const config = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#interactive'),
                            constraints: constraints,
                            area: {
                                top: "0%",
                                right: "0%",
                                left: "0%",
                                bottom: "0%"
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: navigator.hardwareConcurrency ? Math.min(navigator.hardwareConcurrency, 4) : 2,
                        decoder: {
                            readers: [this.barcodeType.value + "_reader"]
                        },
                        locate: true
                    };
                    
                    await new Promise((resolve, reject) => {
                        QuaggaLib.init(config, (err) => {
                            if (err) {
                                console.error('Quagga初期化エラー:', err);
                                reject(err);
                                return;
                            }
                            
                            const endTime = performance.now();
                            const cameraTime = Math.round(endTime - startTime);
                            this.cameraStartTimeEl.textContent = cameraTime + ' ms';
                            
                            QuaggaLib.start();
                            this.isScanning = true;
                            this.updateButtonStates();
                            resolve();
                        });
                    });
                    
                } catch (error) {
                    console.error('カメラ開始エラー:', error);
                    alert('カメラの開始に失敗しました: ' + error.message);
                    this.isScanning = false;
                    this.updateButtonStates();
                }
            }
            
            stopCamera() {
                try {
                    if (this.currentQuaggaInstance && this.isScanning) {
                        this.currentQuaggaInstance.stop();
                    }
                } catch (error) {
                    console.error('カメラ停止エラー:', error);
                } finally {
                    this.isScanning = false;
                    this.currentQuaggaInstance = null;
                    this.updateButtonStates();
                    
                    // プレビューをクリア
                    document.querySelector('#interactive').innerHTML = 
                        '<div class="flex items-center justify-center h-full text-gray-500">カメラを開始してください</div>';
                }
            }
            
            async performScan() {
                if (!this.isScanning || !this.currentQuaggaInstance) {
                    alert('最初にカメラを開始してください');
                    return;
                }
                
                this.scanStartTime = performance.now();
                this.scanTimeEl.textContent = '測定中...';
                
                try {
                    const QuaggaLib = this.currentQuaggaInstance;
                    
                    // 既存のリスナーをクリア
                    QuaggaLib.offDetected();
                    
                    // 一回限りの検出イベントリスナーを設定
                    const detectHandler = (result) => {
                        const endTime = performance.now();
                        const scanTime = Math.round(endTime - this.scanStartTime);
                        const cameraTime = Math.round(this.scanStartTime - this.cameraStartTime);
                        
                        this.scanTimeEl.textContent = scanTime + ' ms';
                        this.resultEl.classList.remove('hidden');
                        this.resultTextEl.textContent = result.codeResult.code;
                        
                        // 測定結果を保存
                        this.saveMeasurement(cameraTime, scanTime, result.codeResult.code);
                        
                        // イベントリスナーを削除
                        QuaggaLib.offDetected(detectHandler);
                    };
                    
                    QuaggaLib.onDetected(detectHandler);
                    
                    // 30秒でタイムアウト
                    setTimeout(() => {
                        QuaggaLib.offDetected(detectHandler);
                        if (this.scanTimeEl.textContent === '測定中...') {
                            this.scanTimeEl.textContent = 'タイムアウト';
                        }
                    }, 30000);
                    
                } catch (error) {
                    console.error('スキャンエラー:', error);
                    this.scanTimeEl.textContent = 'エラー';
                }
            }
            
            saveMeasurement(cameraTime, scanTime, result) {
                const measurement = {
                    id: this.measurements.length + 1,
                    library: this.currentLibrary === 'quagga' ? 'Quagga v0.12.1' : 'Quagga2',
                    resolution: this.resolutionSelect.value,
                    cameraTime: cameraTime,
                    scanTime: scanTime,
                    result: result,
                    timestamp: new Date().toLocaleString('ja-JP')
                };
                
                this.measurements.push(measurement);
                this.updateResultsTable();
                this.updateStatistics();
            }
            
            updateResultsTable() {
                if (this.measurements.length === 0) return;
                
                const tbody = this.resultsTableBody;
                tbody.innerHTML = '';
                
                this.measurements.forEach(measurement => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2">${measurement.id}</td>
                        <td class="border border-gray-300 px-4 py-2">${measurement.library}</td>
                        <td class="border border-gray-300 px-4 py-2">${measurement.resolution}</td>
                        <td class="border border-gray-300 px-4 py-2">${measurement.cameraTime} ms</td>
                        <td class="border border-gray-300 px-4 py-2">${measurement.scanTime} ms</td>
                        <td class="border border-gray-300 px-4 py-2 font-mono text-sm">${measurement.result}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm">${measurement.timestamp}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            updateStatistics() {
                if (this.measurements.length === 0) return;
                
                const avgCamera = Math.round(
                    this.measurements.reduce((sum, m) => sum + m.cameraTime, 0) / this.measurements.length
                );
                const avgScan = Math.round(
                    this.measurements.reduce((sum, m) => sum + m.scanTime, 0) / this.measurements.length
                );
                
                this.avgCameraTime.textContent = avgCamera + ' ms';
                this.avgScanTime.textContent = avgScan + ' ms';
                this.statsSection.classList.remove('hidden');
            }
            
            updateButtonStates() {
                this.startCameraBtn.disabled = this.isScanning;
                this.stopCameraBtn.disabled = !this.isScanning;
                this.scanBarcodeBtn.disabled = !this.isScanning;
            }
            
            resetResults() {
                this.measurements = [];
                this.cameraStartTimeEl.textContent = '-- ms';
                this.scanTimeEl.textContent = '-- ms';
                this.resultEl.classList.add('hidden');
                this.statsSection.classList.add('hidden');
                
                this.resultsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                            まだ測定結果がありません
                        </td>
                    </tr>
                `;
            }
        }
        
        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            new QuaggaBenchmark();
        });
    </script>
</body>
</html>
