<!DOCTYPE html>
<html lang="ja" xmlns="http://www.w3.org/1999/html">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CheckMate</title>

<!-- SEO and Social Sharing Meta Tags -->
<meta name="description" content="æ—¥ã€…ã®æŒã¡ç‰©ã‚’ç®¡ç†ã—ã€å¿˜ã‚Œç‰©ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆPWAã§ã™ã€‚æ›œæ—¥ã”ã¨ã®ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²ã‚„PWAå¯¾å¿œã§ã€ã‚ãªãŸã®ã€Œã†ã£ã‹ã‚Šã€ã‚’ãªãã—ã¾ã™ã€‚">
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<!-- TODO: Replace with the final, absolute URL of your deployed app -->
<meta property="og:url" content="https://vol-11.github.io/CheckMate-V2/">
<meta property="og:title" content="CheckMate">
<meta property="og:description" content="æ—¥ã€…ã®æŒã¡ç‰©ã‚’ç®¡ç†ã—ã€å¿˜ã‚Œç‰©ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆPWAã§ã™ã€‚æ›œæ—¥ã”ã¨ã®ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²ã‚„PWAå¯¾å¿œã§ã€ã‚ãªãŸã®ã€Œã†ã£ã‹ã‚Šã€ã‚’ãªãã—ã¾ã™ã€‚">
<!-- TODO: Replace with the final, absolute URL to your icon image -->
<meta property="og:image" content="https://vol-11.github.io/CheckMate-V2/icons/icon-48.png">
<!-- Twitter -->
<meta property="twitter:card" content="https://vol-11.github.io/CheckMate-V2/icons/icon-512.png">
<!-- TODO: Replace with the final, absolute URL of your deployed app -->
<meta property="twitter:url" content="https://vol-11.github.io/CheckMate-V2/">
<meta property="twitter:title" content="CheckMate">
<meta property="twitter:description" content="æ—¥ã€…ã®æŒã¡ç‰©ã‚’ç®¡ç†ã—ã€å¿˜ã‚Œç‰©ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆPWAã§ã™ã€‚æ›œæ—¥ã”ã¨ã®ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²ã‚„PWAå¯¾å¿œã§ã€ã‚ãªãŸã®ã€Œã†ã£ã‹ã‚Šã€ã‚’ãªãã—ã¾ã™ã€‚">
<!-- TODO: Replace with the final, absolute URL to your icon image -->
<meta property="twitter:image" content="https://vol-11.github.io/CheckMate-V2/icons/icon-48.png">

<meta name="theme-color" content="#007bff">
<script src="https://cdn.tailwindcss.com"></script>
<script src="js/style_config.js"></script>
<script src="js/dark_mode_startup.js"></script>
<style>
    /* é »ç¹ã«å¿˜ã‚Œã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes pulse-ring {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
      }
      50% {
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0);
      }
    }
    .is-forgotten-frequently {
        animation: pulse-ring 2s infinite;
    }
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-48.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/icon-48.png">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
<div class="max-w-lg mx-auto p-2 sm:p-4">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="relative bg-gradient-to-r from-blue-600 to-blue-700 dark:from-blue-700 dark:to-blue-800 text-white p-4 sm:p-6 rounded-xl text-center mb-4 shadow-lg">
  <h1 class="text-xl sm:text-2xl font-bold">CheckMate v2Î¶</h1>
  <p class="text-blue-100 dark:text-blue-200">æ•™æãƒ»æŒã¡ç‰©ã‚’ã¾ã¨ã‚ã¦ç®¡ç†ï¼</p>
  
  <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
  <div class="absolute top-3 right-3 sm:top-4 sm:right-4">
    <button id="theme-toggle" class="p-2 rounded-lg bg-white/20 hover:bg-white/30 transition-colors duration-200">
      <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
      </svg>
      <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
</header>

<!-- çµ±è¨ˆæƒ…å ± -->
<div class="grid grid-cols-3 gap-2 sm:gap-4 text-center mb-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
    <div id="total-items" class="text-xl font-bold text-blue-600 dark:text-blue-400">0</div>
    <div class="text-xs text-gray-500 dark:text-gray-400">ç·ã‚¢ã‚¤ãƒ†ãƒ </div>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
    <div id="checked-items" class="text-xl font-bold text-green-600 dark:text-green-400">0</div>
    <div class="text-xs text-gray-500 dark:text-gray-400">ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
    <div id="today-items" class="text-xl font-bold text-orange-600 dark:text-orange-400">0</div>
    <div class="text-xs text-gray-500 dark:text-gray-400">æ˜æ—¥ã®åˆ†</div>
  </div>
</div>

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="flex bg-white dark:bg-gray-800 rounded-lg mb-4 overflow-hidden shadow-md">
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 bg-blue-600 text-white" data-tab="check">âœ… ãƒã‚§ãƒƒã‚¯</button>
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="calendar">ğŸ“… æ—¥ç¨‹</button>
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="scanner">ğŸ“± ç™»éŒ²</button>
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="items">ğŸ“‹ ä¸€è¦§</button>
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="forgotten">ğŸ˜¥ å¿˜ã‚Œç‰©</button>
  <button class="tab-btn flex-1 py-3 px-2 text-xs sm:text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="settings">âš™ï¸ è¨­å®š</button>
</nav>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ– -->
<div id="calendar" class="tab-content hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
        <!-- Calendar Header -->
        <div class="flex justify-between items-center mb-4">
            <button id="prev-month-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">â€¹</button>
            <h3 id="calendar-month-year" class="text-lg font-semibold"></h3>
            <button id="next-month-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">â€º</button>
        </div>
        <!-- Calendar Grid -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
            <!-- Day headers will be injected here -->
        </div>
    </div>
    <div id="date-specific-checklist-container" class="hidden bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 shadow-md">
        <h3 class="text-lg font-semibold mb-4">
            <span class="mr-2">ğŸ—“ï¸</span>
            <span id="selected-date-display"></span> ã®æŒã¡ç‰©
        </h3>
        <ul id="date-specific-checklist" class="space-y-2 mb-4">
            <!-- Checklist for the selected date will be rendered here -->
        </ul>
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ–å†…ã®ç‰¹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ éƒ¨åˆ†ã‚’ç½®ãæ›ãˆ -->
        <div class="flex gap-2 mb-4">
          <input type="text" id="special-item-name" placeholder="ã“ã®æ—¥ã ã‘ã®æŒã¡ç‰©ã‚’è¿½åŠ " class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
          <button id="add-special-item-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">â• è¿½åŠ </button>
        </div>

        <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¿½åŠ  -->
        <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 mb-4">
          <h4 class="text-sm font-semibold mb-3 flex items-center"><span class="mr-2">ğŸ“±</span>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§è¿½åŠ </h4>

          <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
          <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg mb-3 overflow-hidden border border-gray-300 dark:border-gray-600">
            <button class="calendar-scan-mode-btn flex-1 py-2 px-3 text-sm font-medium transition-all duration-200 bg-blue-600 text-white" data-mode="manual">âœ‹ æ‰‹å‹•å…¥åŠ›</button>
            <button class="calendar-scan-mode-btn flex-1 py-2 px-3 text-sm font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-mode="scan">ğŸ“± ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</button>
          </div>

          <!-- æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
          <div id="calendar-manual-mode">
            <div class="flex gap-2">
              <input type="text" id="special-item-barcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ‰‹å…¥åŠ›" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
              <button id="add-special-barcode-btn" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm">ğŸ“– ç™»éŒ²</button>
            </div>
          </div>

          <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ -->
          <div id="calendar-scan-mode" class="hidden">
            <div id="calendar-viewport" class="relative w-full h-64 border-2 border-blue-600 dark:border-blue-400 rounded-xl overflow-hidden bg-black mb-4">
              <video id="calendar-video" class="w-full h-full object-cover"></video>
              <canvas id="calendar-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
              <div class="guide absolute top-[20%] left-[15%] right-[15%] bottom-[20%] border-4 border-dashed border-green-400 bg-green-400/10 pointer-events-none rounded-lg"></div>
            </div>
            <div id="calendar-status" class="p-2 rounded-lg mb-3 text-center text-sm font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ç™»éŒ²</div>
            <div class="text-center">
              <button id="calendar-scan-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm mr-2">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
              <button id="calendar-stop-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-medium transition-colors text-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>â¹ åœæ­¢</button>
            </div>
          </div>
        </div>
    </div>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ãƒ–ï¼ˆç™»éŒ²ç”¨ï¼‰ -->
<div id="scanner" class="tab-content hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <div id="viewport" class="relative w-full h-64 border-2 border-blue-600 dark:border-blue-400 rounded-xl overflow-hidden bg-black mb-4">
      <video id="video" class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
      <div class="guide absolute top-[20%] left-[15%] right-[15%] bottom-[20%] border-4 border-dashed border-green-400 bg-green-400/10 pointer-events-none rounded-lg"></div>
    </div>
    <div id="status" class="p-3 rounded-lg mb-4 text-center font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700">ğŸ“· æº–å‚™å®Œäº† - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    <div class="text-center">
      <button id="scan-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors duration-200 mr-2">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
      <button id="stop-btn" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>â¹ åœæ­¢</button>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ“–</span>è©³ç´°ç™»éŒ²</h3>
    
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">ã‚¢ã‚¤ãƒ†ãƒ å *</label>
      <input type="text" id="detail-name" placeholder="ä¾‹: æ•°å­¦ã®æ•™ç§‘æ›¸" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
        <select id="detail-category" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
          <option value="æ•™æ">ğŸ“š æ•™æ</option>
          <option value="æ–‡æˆ¿å…·">âœï¸ æ–‡æˆ¿å…·</option>
          <option value="ä½“è‚²ç”¨å“">âš½ ä½“è‚²ç”¨å“</option>
          <option value="å¼å½“">ğŸ± å¼å½“</option>
          <option value="åˆ¶æœãƒ»æœè£…">ğŸ‘” åˆ¶æœãƒ»æœè£…</option>
          <option value="æ¥½å™¨">ğŸµ æ¥½å™¨</option>
          <option value="éƒ¨æ´»ç”¨å“">ğŸƒ éƒ¨æ´»ç”¨å“</option>
          <option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">é‡è¦åº¦</label>
        <select id="detail-priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
          <option value="æ™®é€š">æ™®é€š</option>
          <option value="é‡è¦">â­ é‡è¦</option>
          <option value="å¿…é ˆ">â€¼ï¸ å¿…é ˆ</option>
        </select>
      </div>
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ (ä»»æ„)</label>
      <input type="text" id="detail-code" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ç‹¬è‡ªID" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">ãƒ¡ãƒ¢ (ä»»æ„)</label>
      <textarea id="detail-memo" rows="2" placeholder="è¿½åŠ æƒ…å ±ã‚„ãƒ¡ãƒ¢" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-medium mb-2">å¿…è¦ãªæ›œæ—¥</label>
      <div class="grid grid-cols-4 sm:grid-cols-7 gap-2" id="detail-days">
        <label><input type="checkbox" value="æœˆ" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æœˆ</div></label>
        <label><input type="checkbox" value="ç«" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">ç«</div></label>
        <label><input type="checkbox" value="æ°´" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æ°´</div></label>
        <label><input type="checkbox" value="æœ¨" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æœ¨</div></label>
        <label><input type="checkbox" value="é‡‘" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">é‡‘</div></label>
        <label><input type="checkbox" value="åœŸ" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">åœŸ</div></label>
        <label><input type="checkbox" value="æ—¥" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æ—¥</div></label>
      </div>
    </div>
    
    <button id="add-detail" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors duration-200">â• è©³ç´°ç™»éŒ²</button>
  </div>
</div>

<!-- ä¸€è¦§ã‚¿ãƒ– -->
<div id="items" class="tab-content hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <div class="relative mb-4">
      <input type="text" id="search-input" placeholder="ğŸ” ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢..." class="w-full pl-3 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
      <button id="search-clear" class="absolute right-2 top-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-lg hidden">Ã—</button>
    </div>
    
    <div class="flex flex-wrap gap-2 mb-4" id="category-tabs">
      <button class="category-btn px-3 py-1 border-2 border-blue-600 bg-blue-600 text-white rounded-full text-sm font-medium transition-all duration-200" data-category="all">å…¨ã¦</button>
      <!-- Category buttons are dynamically inserted here -->
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 shadow-md">
    <h3 id="items-title" class="text-lg font-semibold mb-4">ğŸ“š å…¨ã‚¢ã‚¤ãƒ†ãƒ  (0ä»¶)</h3>
    <ul id="items-list" class="space-y-3"></ul>
    <div class="text-center mt-4 space-x-2">
      <button id="sort-toggle" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">ğŸ“Š ä¸¦ã³æ›¿ãˆ</button>
    </div>
  </div>
</div>

<!-- ãƒã‚§ãƒƒã‚¯ã‚¿ãƒ– -->
<div id="check" class="tab-content">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">âœ…</span>æ—¥ä»˜ã‚’é¸æŠã—ã¦ãƒã‚§ãƒƒã‚¯</h3>
    <div class="flex items-center gap-4 mb-4">
        <label for="check-date-picker" class="font-medium">æ—¥ä»˜:</label>
        <input type="date" id="check-date-picker" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ“·</span>ãƒã‚§ãƒƒã‚¯æ–¹æ³•é¸æŠ</h3>
    <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg mb-4 overflow-hidden border border-gray-300 dark:border-gray-600">
      <button class="scan-mode-btn flex-1 py-2 px-4 font-medium transition-all duration-200 bg-blue-600 text-white" data-mode="manual">âœ‹ æ‰‹å‹•ãƒã‚§ãƒƒã‚¯</button>
      <button class="scan-mode-btn flex-1 py-2 px-4 font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-mode="scan">ğŸ“± ã‚¹ã‚­ãƒ£ãƒ³ãƒã‚§ãƒƒã‚¯</button>
    </div>

    <!-- æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
    <div id="manual-check-mode">
      <div id="check-progress" class="text-center my-4 font-semibold"></div>
      <ul id="checklist" class="space-y-3"></ul>
      <div class="text-center mt-4 space-x-2">
        <button id="check-all" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">âœ… å…¨é¸æŠ</button>
        <button id="uncheck-all" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">â­• å…¨è§£é™¤</button>
        <button id="reset-check" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
    <div id="scan-check-mode" class="hidden">
      <div id="check-viewport" class="relative w-full h-64 border-2 border-blue-600 dark:border-blue-400 rounded-xl overflow-hidden bg-black mb-4">
        <video id="check-video" class="w-full h-full object-cover"></video>
        <canvas id="check-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        <div class="guide absolute top-[20%] left-[15%] right-[15%] bottom-[20%] border-4 border-dashed border-green-400 bg-green-400/10 pointer-events-none rounded-lg"></div>
      </div>
      <div id="check-status" class="p-3 rounded-lg mb-4 text-center font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯</div>
      <div class="text-center mb-4">
        <button id="check-scan-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors duration-200 mr-2">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
        <button id="check-stop-btn" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>â¹ åœæ­¢</button>
      </div>
      <div id="check-result" class="check-result hidden p-4 rounded-lg mb-4 text-center font-semibold"></div>

      <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å…±é€šã®ãƒã‚§ãƒƒã‚¯çŠ¶æ³è¡¨ç¤º -->
      <div class="mt-4">
        <div id="scan-check-progress" class="text-center my-4 font-semibold"></div>
        <ul id="scan-checklist" class="space-y-3"></ul>
        <div class="text-center mt-4 space-x-2">
          <button id="scan-check-all" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">âœ… å…¨é¸æŠ</button>
          <button id="scan-uncheck-all" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">â­• å…¨è§£é™¤</button>
          <button id="scan-reset-check" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="mt-8">
        <h4 class="text-lg font-semibold mb-3">ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³çµæœ</h4>
        <ul id="scan-results" class="space-y-2"></ul>
      </div>
    </div>
  </div>
</div>

<!-- å¿˜ã‚Œç‰©ã‚¿ãƒ– -->
<div id="forgotten" class="tab-content hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
        <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg mb-4 overflow-hidden border border-gray-300 dark:border-gray-600">
            <button id="forgotten-record-tab-btn" class="flex-1 py-2 px-4 font-medium transition-all duration-200 bg-blue-600 text-white" data-mode="record">ğŸ“ è¨˜éŒ²</button>
            <button id="forgotten-history-tab-btn" class="flex-1 py-2 px-4 font-medium transition-all duration-200 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-mode="history">ğŸ“ˆ å±¥æ­´</button>
        </div>

        <!-- è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="forgotten-record-mode">
            <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="mr-2">ğŸ˜¥</span>ä»Šæ—¥ã®å¿˜ã‚Œç‰©</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">ä»Šæ—¥å¿˜ã‚ŒãŸã‚‚ã®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            <ul id="today-forgotten-checklist" class="space-y-3 mb-4"></ul>
            <button id="save-today-forgotten" class="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors duration-200">ğŸ’¾ ä»Šæ—¥ã®å¿˜ã‚Œç‰©ã‚’è¨˜éŒ²</button>
        </div>

        <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="forgotten-history-mode" class="hidden">
            <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ“Š</span>å¿˜ã‚Œç‰© çµ±è¨ˆ</h3>
            <div id="forgotten-stats" class="mb-6">
                <!-- å¿˜ã‚Œç‰©çµ±è¨ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold flex items-center"><span class="mr-2">ğŸ“œ</span>å¿˜ã‚Œç‰© å…¨å±¥æ­´</h3>
                <button id="delete-old-forgotten-btn" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">1ãƒ¶æœˆä»¥ä¸Šå‰ã‚’å‰Šé™¤</button>
            </div>
            <div id="forgotten-list">
                <!-- å¿˜ã‚Œç‰©ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
</div>

<!-- è¨­å®šã‚¿ãƒ– -->
<div id="settings" class="tab-content hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ“Š</span>çµ±è¨ˆæƒ…å ±</h3>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="detailed-stats">
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="stat-total">0</div>
        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°</div>
      </div>
      <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="stat-categories">0</div>
        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°</div>
      </div>
      <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="stat-barcodes">0</div>
        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä»˜ã</div>
      </div>
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/30 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="stat-completion">0%</div>
        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">å®Œäº†ç‡</div>
      </div>
    </div>
  </div>

  <div id="notification-settings-container" class="hidden bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ””</span>é€šçŸ¥è¨­å®š</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
      ã“ã®æ©Ÿèƒ½ã¯PWAã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚æŒ‡å®šã—ãŸæ™‚åˆ»ã«ã€ç¿Œæ—¥ã®æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’é€šçŸ¥ã—ã¾ã™ã€‚
    </p>
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <label for="notification-toggle" class="font-medium text-gray-800 dark:text-gray-200">é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
        <label for="notification-toggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="notification-toggle" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
        </label>
      </div>
      <div id="notification-options" class="hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
          <label for="notification-time" class="font-medium text-gray-800 dark:text-gray-200">é€šçŸ¥æ™‚åˆ»</label>
          <input type="time" id="notification-time" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="flex items-center justify-between">
          <label for="renotify-toggle" class="font-medium text-gray-800 dark:text-gray-200">é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ã®å†é€šçŸ¥</label>
          <label for="renotify-toggle" class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="renotify-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
          </label>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          ã€Œå¿…é ˆã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã€ã‚ˆãå¿˜ã‚Œã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒæœªãƒã‚§ãƒƒã‚¯ã®å ´åˆã€10åˆ†ãŠãã«å†é€šçŸ¥ã—ã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">âš™ï¸</span>ãƒ‡ãƒ¼ã‚¿ç®¡ç† (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</h3>
    <div class="grid grid-cols-2 gap-2 mb-4">
      <button id="export-btn" class="py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200">â¬‡ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label for="import-file" class="py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors duration-200 cursor-pointer text-center flex items-center justify-center">â¬† JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
    </div>
    <input type="file" id="import-file" class="hidden" accept="application/json">
    <div class="grid grid-cols-2 gap-2">
      <button id="backup-btn" class="py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-medium transition-colors duration-200">ğŸ’¾ ç°¡æ˜“ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button id="restore-btn" class="py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors duration-200">ğŸ”„ ç°¡æ˜“å¾©å…ƒ</button>
    </div>
    <div id="status-msg" class="mt-4 text-center font-semibold"></div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md border-2 border-red-500/50">
    <h3 class="text-lg font-semibold mb-4 flex items-center text-red-600 dark:text-red-400"><span class="mr-2">âš ï¸</span>ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚å®Ÿè¡Œã™ã‚‹å‰ã«ã€å¿…è¦ã§ã‚ã‚Œã°ä¸Šè¨˜ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="reset-forgotten-history-btn" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200">ğŸ˜¥ å¿˜ã‚Œç‰©å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="reset-categories-btn" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="reset-all-items-btn" class="w-full py-2 px-4 bg-red-800 hover:bg-red-900 text-white rounded-lg font-medium transition-colors duration-200 sm:col-span-2">ğŸ—‘ å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 mb-4 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ·ï¸</span>ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h3>
    <div class="flex gap-2 mb-4">
      <input type="text" id="new-category-name" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-base">
      <button id="add-category-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors duration-200 whitespace-nowrap">â• è¿½åŠ </button>
    </div>
    <ul id="category-management-list" class="space-y-2">
      <!-- ã‚«ãƒ†ã‚´ãƒªãŒå‹•çš„ã«ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </ul>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 shadow-md">
    <h3 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ğŸ“±</span>PWAæƒ…å ±</h3>
    <p class="text-gray-600 dark:text-gray-400 mb-3">ã“ã®ã‚¢ãƒ—ãƒªã¯PWAå¯¾å¿œã§ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ï¼š</p>
    <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1 mb-4">
      <li>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ</li>
      <li>ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ </li>
      <li>ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šä¿å­˜</li>
      <li>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯</li>
    </ul>
    <button id="install-pwa" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors duration-200 hidden">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
  </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 flex justify-center items-center hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-[90%] max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">âœï¸ ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†</h3>
      <button class="text-2xl hover:text-gray-600 dark:hover:text-gray-400 transition-colors" onclick="closeEditModal()">Ã—</button>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">ã‚¢ã‚¤ãƒ†ãƒ å</label>
        <input type="text" id="edit-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
          <select id="edit-category" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            <!-- Options are dynamically inserted here -->
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">é‡è¦åº¦</label>
          <select id="edit-priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="é‡è¦">â­ é‡è¦</option>
            <option value="å¿…é ˆ">â€¼ï¸ å¿…é ˆ</option>
          </select>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="edit-code" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">ãƒ¡ãƒ¢</label>
        <textarea id="edit-memo" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">å¿…è¦ãªæ›œæ—¥</label>
        <div id="edit-days" class="grid grid-cols-4 sm:grid-cols-7 gap-2">
          <label><input type="checkbox" value="æœˆ" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æœˆ</div></label>
          <label><input type="checkbox" value="ç«" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">ç«</div></label>
          <label><input type="checkbox" value="æ°´" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æ°´</div></label>
          <label><input type="checkbox" value="æœ¨" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æœ¨</div></label>
          <label><input type="checkbox" value="é‡‘" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">é‡‘</div></label>
          <label><input type="checkbox" value="åœŸ" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">åœŸ</div></label>
          <label><input type="checkbox" value="æ—¥" class="sr-only peer"><div class="cursor-pointer text-center p-2 border rounded-lg transition-colors peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 dark:border-gray-600 dark:peer-checked:border-blue-600 hover:bg-gray-100 dark:hover:bg-gray-700">æ—¥</div></label>
        </div>
      </div>
      
      <div class="flex gap-2 mt-6">
        <button id="save-edit" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors duration-200">ğŸ’¾ ä¿å­˜</button>
        <button onclick="closeEditModal()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors duration-200">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
</div>

</div>


<script src="js/dark_mode.js"></script>
<script src="js/indexdb.js"></script>
<script src="js/global.js"></script>
<script src="js/ui.js"></script>
<script src="js/tab.js"></script>
<script src="js/scan_mode.js"></script>
<script src="js/stats.js"></script>
<script src="js/items.js"></script>
<script src="js/checklist.js"></script>
<script src="js/category.js"></script>
<script src="js/calendar.js"></script>
<script src="js/backup.js"></script>
<script src="js/pwa.js"></script>
<script src="js/sort.js"></script>
<script src="js/search.js"></script>
<script src="js/stats_util.js"></script>
<script src="js/forgotten.js"></script>
<script src="js/notifications.js"></script>
<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@zxing/browser@latest"></script>

<script>
window.addEventListener('load', () => {
// è©³ç´°ç™»éŒ²
document.getElementById('add-detail').addEventListener('click', async () => {
  const name = document.getElementById('detail-name').value;
  const category = document.getElementById('detail-category').value;
  const priority = document.getElementById('detail-priority').value;
  const code = document.getElementById('detail-code').value;
  const memo = document.getElementById('detail-memo').value;
  const dayCheckboxes = document.querySelectorAll('#detail-days input[type=checkbox]');
  const days = Array.from(dayCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
  
  if (!name.trim()) {
    document.getElementById('detail-name').focus();
    showStatus('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  const success = await addNewItem({ name, category, priority, code, memo, days });
  if (success) {
    document.getElementById('detail-name').value = '';
    document.getElementById('detail-code').value = '';
    document.getElementById('detail-memo').value = '';
    dayCheckboxes.forEach(cb => cb.checked = false);
    
    updateStats();
    renderItems();
    updateCheckDisplay();
    showStatus(`âœ… ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
  }
});

// ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¨­å®š
const scanBtn = document.getElementById('scan-btn');
const stopBtn = document.getElementById('stop-btn');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const statusMessage = document.getElementById('status');

const checkScanBtn = document.getElementById('check-scan-btn');
const checkStopBtn = document.getElementById('check-stop-btn');
const checkVideo = document.getElementById('check-video');
const checkCanvas = document.getElementById('check-canvas');
const checkStatusMessage = document.getElementById('check-status');


let animationFrameId;
let checkAnimationFrameId;

const hints = new Map();
hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [window.ZXing.BarcodeFormat.EAN_13]);
hints.set(window.ZXing.DecodeHintType.TRY_HARDER, false);

window.codeReader = new ZXingBrowser.BrowserMultiFormatReader(hints);
let selectedDeviceId = undefined;
let checkSelectedDeviceId = undefined;
let scanControls = null;
let checkScanControls = null;
ZXingBrowser.BrowserMultiFormatReader.listVideoInputDevices(hints)
  .then((videoInputDevices) => {
    if (videoInputDevices.length > 0) {
      // è¤‡æ•°ã®ã‚«ãƒ¡ãƒ©ãŒã‚ã‚‹å ´åˆã€ã“ã“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½
      selectedDeviceId = videoInputDevices[0].deviceId;
      checkSelectedDeviceId = videoInputDevices[0].deviceId;
    }
  })
  .catch((err) => {
    console.error(err);
  });

// ç™»éŒ²ç”¨ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡º
function onDetected(result) {
  const code = result.getText();
  if (!code) return;

  const existing = items.find(i => i.code === code);
  if (existing) {
    statusMessage.textContent = `âœ… æ—¢ã«ç™»éŒ²æ¸ˆã¿: ${existing.name} (${code})`;
    statusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700';
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    return;
  }

  statusMessage.textContent = `ğŸ“– æ¤œå‡º: ${code} - ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
  statusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
  document.getElementById('detail-code').value = code;
  document.getElementById('detail-name').focus();

  if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
  stopScanning();
    // è©³ç´°ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    document.getElementById('detail-name').scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }, 100);
}

// ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function showCheckResult(title, type, subtitle) {
    const checkResult = document.getElementById('check-result');
    let bgClass, textClass, borderClass;

    switch(type) {
        case 'success':
            bgClass = 'bg-green-100 dark:bg-green-900/30';
            textClass = 'text-green-700 dark:text-green-300';
            borderClass = 'border-green-300 dark:border-green-700';
            break;
        case 'warning':
            bgClass = 'bg-yellow-100 dark:bg-yellow-900/30';
            textClass = 'text-yellow-700 dark:text-yellow-300';
            borderClass = 'border-yellow-300 dark:border-yellow-700';
            break;
        case 'error':
            bgClass = 'bg-red-100 dark:bg-red-900/30';
            textClass = 'text-red-700 dark:text-red-300';
            borderClass = 'border-red-300 dark:border-red-700';
            break;
    }

    checkResult.className = `p-4 rounded-lg mb-4 text-center font-semibold ${bgClass} ${textClass} border ${borderClass}`;
    checkResult.innerHTML = `
        <div>${title}</div>
        <div class="text-sm mt-1">${subtitle}</div>
    `;
    checkResult.classList.remove('hidden');
}

// ãƒã‚§ãƒƒã‚¯ç”¨ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡º
async function onCheckDetected(result) {
    const code = result.getText();
    if (!code) return;

    const currentDay = window.currentDay;
    if (!currentDay) {
        console.warn('currentDay is not set');
        return;
    }

    // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
    const checkDate = document.getElementById('check-date-picker').value;

    // é€šå¸¸ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒã‚§ãƒƒã‚¯
    const dayItems = items.filter(i => i.days.includes(currentDay));
    const foundItem = dayItems.find(i => i.code === code);

    // ç‰¹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ãƒã‚§ãƒƒã‚¯
    const override = await getOverride(checkDate);
    const specialItem = override?.added?.find(item => item.code === code);

    if (foundItem) {
        // é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        if (!foundItem.checked) {
            foundItem.checked = true;
            updateItem(foundItem);
            updateStats();
            updateCheckDisplay();

            scanResults.set(code, {
                item: foundItem,
                timestamp: new Date(),
                status: 'checked'
            });

            checkStatusMessage.textContent = `âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†: ${foundItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700';

            showCheckResult(`âœ… ${foundItem.name}`, 'success', 'è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸ');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
        } else {
            checkStatusMessage.textContent = `â„¹ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿: ${foundItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
    } else if (specialItem) {
        // ç‰¹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†
        if (!specialItem.checked) {
            specialItem.checked = true;
            await saveOverride(override);
            updateStats();
            updateCheckDisplay();

            scanResults.set(code, {
                item: specialItem,
                timestamp: new Date(),
                status: 'checked'
            });

            checkStatusMessage.textContent = `âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†: ${specialItem.name} (ç‰¹åˆ¥)`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700';

            showCheckResult(`âœ… ${specialItem.name}`, 'success', 'ã“ã®æ—¥é™å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã§ã™');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
        } else {
            checkStatusMessage.textContent = `â„¹ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿: ${specialItem.name} (ç‰¹åˆ¥)`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
    } else {
        // æ—¢å­˜ã®æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç†
        const anyItem = items.find(i => i.code === code);
        if (anyItem) {
            checkStatusMessage.textContent = `âš ï¸ ${currentDay}æ›œæ—¥ã«ã¯ä¸è¦: ${anyItem.name}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700';
            showCheckResult(`âš ï¸ ${anyItem.name}`, 'warning', `${currentDay}æ›œæ—¥ã®ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“`);
        } else {
            checkStatusMessage.textContent = `âŒ æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ : ${code}`;
            checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700';
            showCheckResult('âŒ æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ ', 'error', `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${code}`);
        }
        if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
    }

    renderScanResults();

    setTimeout(() => {
        checkStatusMessage.textContent = 'ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯';
        checkStatusMessage.className = 'p-3 rounded-lg mb-4 text-center font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
        document.getElementById('check-result').classList.add('hidden');
    }, 3000);
}

function getCenter(points) {
    let x = 0;
    let y = 0;
    points.forEach(p => {
        x += p.x;
        y += p.y;
    });
    return { x: x / points.length, y: y / points.length };
}

function processVideo(videoElement, canvasElement, animationFrameHolder) {
    // Temporarily disabled for debugging
}

async function startScanning() {
    if (isScanning) return;
    isScanning = true;
    scanBtn.disabled = true;
    stopBtn.disabled = false;
    statusMessage.textContent = 'ğŸ¥ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';

    try {
        const constraints = {
            video: {
                width: { ideal: 818 },
                height: { ideal: 460 },
                deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                facingMode: !selectedDeviceId ? 'environment' : undefined
            }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        statusMessage.textContent = 'ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
        animationFrameId = requestAnimationFrame(scanLoop);
    } catch (err) {
        console.error('startScanning: catch error', err);
        statusMessage.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
        isScanning = false;
        scanBtn.disabled = false;
        stopBtn.disabled = true;
    }
}

function scanLoop() {
    if (!isScanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const avg = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
        }
        ctx.putImageData(imageData, 0, 0);

        try {
            const result = codeReader.decodeFromCanvas(canvas);
            if (result) {
                onDetected(result);
            }
        } catch (err) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ¤å®šã™ã‚‹æ–¹æ³•ã«å¤‰æ›´
            if (!(err instanceof ZXing.NotFoundException) &&
                !err.message?.includes('No MultiFormat Readers were able to detect the code') &&
                !err.message?.includes('NotFoundException')) {
                console.error('Scan error:', err);
            }
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆæ­£å¸¸å‹•ä½œï¼‰
        }
    }
    animationFrameId = requestAnimationFrame(scanLoop);
}

function stopScanning() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    isScanning = false;
    statusMessage.textContent = 'ğŸ“· æº–å‚™å®Œäº† - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
    scanBtn.disabled = false;
    stopBtn.disabled = true;
}

async function startCheckScanning() {
    if (isCheckScanning) return;
    isCheckScanning = true;
    checkScanBtn.disabled = true;
    checkStopBtn.disabled = false;
    checkStatusMessage.textContent = 'ğŸ¥ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';

    try {
        const constraints = {
            video: {
                width: { ideal: 818 },
                height: { ideal: 460 },
                deviceId: checkSelectedDeviceId ? { exact: checkSelectedDeviceId } : undefined,
                facingMode: !checkSelectedDeviceId ? 'environment' : undefined
            }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        checkVideo.srcObject = stream;
        await checkVideo.play();
        checkStatusMessage.textContent = 'ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
        checkAnimationFrameId = requestAnimationFrame(checkScanLoop);
    } catch (err) {
        console.error('startCheckScanning: catch error', err);
        checkStatusMessage.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
        isCheckScanning = false;
        checkScanBtn.disabled = false;
        checkStopBtn.disabled = true;
    }
}

function checkScanLoop() {
    if (!isCheckScanning) return;

    if (checkVideo.readyState === checkVideo.HAVE_ENOUGH_DATA) {
        checkCanvas.height = checkVideo.videoHeight;
        checkCanvas.width = checkVideo.videoWidth;
        const ctx = checkCanvas.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(checkVideo, 0, 0, checkCanvas.width, checkCanvas.height);

        const imageData = ctx.getImageData(0, 0, checkCanvas.width, checkCanvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const avg = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
        }
        ctx.putImageData(imageData, 0, 0);

        try {
            const result = codeReader.decodeFromCanvas(checkCanvas);
            if (result) {
                onCheckDetected(result);
            }
        } catch (err) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ¤å®šã™ã‚‹æ–¹æ³•ã«å¤‰æ›´
            if (!(err instanceof ZXing.NotFoundException) &&
                !err.message?.includes('No MultiFormat Readers were able to detect the code') &&
                !err.message?.includes('NotFoundException')) {
                console.error('Check scan error:', err);
            }
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆæ­£å¸¸å‹•ä½œï¼‰
        }
    }
    checkAnimationFrameId = requestAnimationFrame(checkScanLoop);
}

function stopCheckScanning() {
    if (checkAnimationFrameId) {
        cancelAnimationFrame(checkAnimationFrameId);
        checkAnimationFrameId = null;
    }
    if (checkVideo.srcObject) {
        checkVideo.srcObject.getTracks().forEach(track => track.stop());
        checkVideo.srcObject = null;
    }
    isCheckScanning = false;
    checkStatusMessage.textContent = 'ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯';
    checkScanBtn.disabled = false;
    checkStopBtn.disabled = true;
}

scanBtn.addEventListener('click', startScanning);
stopBtn.addEventListener('click', stopScanning);
checkScanBtn.addEventListener('click', startCheckScanning);
checkStopBtn.addEventListener('click', stopCheckScanning);


// ã‚¹ã‚­ãƒ£ãƒ³çµæœè¡¨ç¤º
function renderScanResults() {
  const list = document.getElementById('scan-results');
  
  if (scanResults.size === 0) {
    list.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 py-4">ã‚¹ã‚­ãƒ£ãƒ³çµæœãªã—</li>';
    return;
  }
  
  list.innerHTML = '';
  
  const sortedResults = Array.from(scanResults.entries())
    .sort(([,a], [,b]) => new Date(b.timestamp) - new Date(a.timestamp));
  
  sortedResults.forEach(([code, result]) => {
    const li = document.createElement('li');
    li.className = 'flex items-center p-3 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 border border-blue-300 dark:border-blue-600 rounded-lg animate-pulse-soft';
    
    const time = result.timestamp.toLocaleTimeString();
    const statusIcon = result.status === 'checked' ? 'âœ…' : 'âŒ';
    
    li.innerHTML = `
      <div class="flex items-center w-full">
        <div class="mr-3 text-xl">${statusIcon}</div>
        <div class="flex-1">
          <div class="font-semibold text-gray-900 dark:text-gray-100">${result.item ? result.item.name : 'æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ '}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">
            ${code} â€¢ ${time}
          </div>
        </div>
      </div>
    `;
    
    list.appendChild(li);
  });
}



// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
function openEditModal(item) {
  editingItem = item;
  document.getElementById('edit-name').value = item.name;
  document.getElementById('edit-category').value = item.category;
  document.getElementById('edit-priority').value = item.priority;
  document.getElementById('edit-code').value = item.code || '';
  document.getElementById('edit-memo').value = item.memo || '';
  
  document.querySelectorAll('#edit-days input[type=checkbox]').forEach(cb => {
    cb.checked = item.days.includes(cb.value);
  });
  
  document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.add('hidden');
  editingItem = null;
}

document.getElementById('save-edit').addEventListener('click', async () => {
  if (!editingItem) return;
  
  const name = document.getElementById('edit-name').value.trim();
  if (!name) {
    showStatus('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  const days = Array.from(document.querySelectorAll('#edit-days input[type=checkbox]:checked'))
                   .map(cb => cb.value);
  
  editingItem.name = name;
  editingItem.category = document.getElementById('edit-category').value;
  editingItem.priority = document.getElementById('edit-priority').value;
  editingItem.code = document.getElementById('edit-code').value.trim();
  editingItem.memo = document.getElementById('edit-memo').value.trim();
  editingItem.days = days;
  editingItem.updatedAt = new Date().toISOString();
  
  try {
    await updateItem(editingItem);
    renderItems();
    updateCheckDisplay();
    updateStats();
    closeEditModal();
    showStatus('âœ… æ›´æ–°ã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    showStatus('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

// å…¨å‰Šé™¤ï¼ˆç¶šãï¼‰

// ãƒ‡ãƒ¼ã‚¿ç®¡ç†
document.getElementById('export-btn').addEventListener('click', async () => {
  try {
    const allItems = await getAllItems();
    const allCategories = await getAllCategories();
    const allForgottenRecords = await getAllForgottenRecords(); // å¿˜ã‚Œç‰©å±¥æ­´ã‚’å–å¾—

    const exportData = {
      version: 3, // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
      categories: allCategories,
      items: allItems,
      forgottenRecords: allForgottenRecords, // å¿˜ã‚Œç‰©å±¥æ­´ã‚’è¿½åŠ 
      exportedAt: new Date().toISOString(),
      app: 'CheckMate-V2'
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CheckMate_v2_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

document.getElementById('import-file').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const data = JSON.parse(reader.result);
      const isNewVersion = (data.version === 2 || data.version === 3) && Array.isArray(data.categories) && Array.isArray(data.items);
      const isOldVersion = !data.version && Array.isArray(data);

      if (!isNewVersion && !isOldVersion) {
        throw new Error('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
      }

      if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        await clearItems();
        await clearCategories();
        await clearForgottenRecords(); // å¿˜ã‚Œç‰©å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢

        let importedItemCount = 0;

        if (isNewVersion) {
          // æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (v2, v3)
          for (const category of data.categories) {
            await addCategory(category);
          }
          for (const item of data.items) {
            delete item.id; // IDã¯è‡ªå‹•æ¡ç•ª
            await addItem(item);
          }
          // v3ä»¥é™ã¯å¿˜ã‚Œç‰©å±¥æ­´ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          if (data.version === 3 && data.forgottenRecords && Array.isArray(data.forgottenRecords)) {
            for (const record of data.forgottenRecords) {
              await addForgottenRecord(record);
            }
          }
          importedItemCount = data.items.length;
        } else {
          // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³
          const importItems = data;
          const categoryNames = new Set();
          for (const item of importItems) {
            delete item.id;
            await addItem(item);
            if (item.category) {
              categoryNames.add(item.category);
            }
          }
          for (const catName of categoryNames) {
            await addCategory({ id: new Date().getTime() + Math.random(), name: catName });
          }
          importedItemCount = importItems.length;
        }

        // UIã‚’å†èª­ã¿è¾¼ã¿ãƒ»å†æç”»
        await loadCategoriesAndInitialize();
        await loadItems();
        await updateDetailedStats();
        scanResults.clear();
        renderScanResults();
        showStatus(`âœ… ${importedItemCount}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
      }
    } catch (err) {
      showStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});



// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadItems() {
  try {
    items = await getAllItems();
    renderItems();
    updateStats();
  } catch (err) {
    console.error('Load items failed:', err);
  }
}

// ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
async function loadCategoriesAndInitialize() {
  try {
    categories = await getAllCategories();
    if (categories.length === 0) {
      // ã‚«ãƒ†ã‚´ãƒªãŒç©ºã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã‚’DBã«è¿½åŠ 
      const defaultCategories = ["æ•™æ", "æ–‡æˆ¿å…·", "ä½“è‚²ç”¨å“", "å¼å½“ãƒ»æ°´ç­’", "åˆ¶æœãƒ»æœè£…", "æ¥½å™¨", "éƒ¨æ´»ç”¨å“", "ãã®ä»–"];
      for (const catName of defaultCategories) {
        const newCat = { id: new Date().getTime() + Math.random(), name: catName };
        await addCategory(newCat);
      }
      categories = await getAllCategories(); // å†èª­ã¿è¾¼ã¿
    }
    renderCategoryManagementList(); // ã‚«ãƒ†ã‚´ãƒªç®¡ç†ãƒªã‚¹ãƒˆã‚’æç”»
    renderCategoryOptions(); // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æç”»
    renderCategoryFilterButtons(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’æç”»
  } catch (err) {
    console.error('Failed to load or initialize categories:', err);
  }
}

// åˆæœŸåŒ–
openDB().then(async () => {
  await loadCategoriesAndInitialize(); // ã‚«ãƒ†ã‚´ãƒªã‚’å…ˆã«èª­ã¿è¾¼ã¿
  await loadItems();
  initializeChecklist();
  await updateCheckDisplay();
  await NotificationManager.init(); // é€šçŸ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
  
  if (items.length === 0) {
    setTimeout(() => {
      showStatus('ğŸ‘‹ ã‚ˆã†ã“ãï¼ã¾ãšã¯æ•™æã‚„æŒã¡ç‰©ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†', 'info');
    }, 1000);
  }
}).catch(err => {
    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
    showStatus('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
});

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
window.addEventListener('beforeunload', () => {
  if (isScanning) stopScanning();
  if (isCheckScanning) stopCheckScanning();
});
});
</script>
</body>
</html>