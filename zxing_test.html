<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Barcode Scanner Benchmark - ZXingå°‚ç”¨</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body{background:#171b26;color:#f3f3f3;}
    body{font-family:system-ui,sans-serif;margin:16px;}
    h1{font-size:20px;margin:0 0 12px;color:#26caf9;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:9px;}
    label{display:inline-flex;align-items:center;gap:6px;}
    select,button{font:inherit;padding:6px 8px;border-radius:4px;border:1px solid #345;}
    button{cursor:pointer;background:#1b5cff;color:#fff;}
    button:hover{background:#1456bf;}
    button:disabled{background:#525f77;cursor:not-allowed;}
    #video{width:min(480px,90vw);aspect-ratio:4/3;background:#000;border-radius:8px;display:block;margin-bottom:10px;}
    #status{padding:10px 16px;margin-bottom:12px;border-radius:8px;font-weight:700;background:#20294D;color:#fff;border:1px solid #36e;font-size:1.1em;}
    #log{margin-top:12px;padding:16px;border-radius:8px;border:1px solid #26caf9;background:#171f31;color:#affbff;white-space:pre-wrap;font-family:ui-monospace,monospace;min-height:100px;max-height:300px;overflow-y:auto;font-size:16px;}
    .note{font-size:13px;color:#d2e4fa;}
    .pill{padding:2px 8px;background:#31c7ba;color:#fff;border-radius:12px;font-weight:700;}
    @media (prefers-color-scheme: light){
     body{background:#f6fbff;color:#224;}
     #status{background:#e5f4f7;color:#212;}
     #log{background:#e2f2ff;color:#026;}
     .note{color:#4d6a75;}
     .pill{background:#ffe49d;color:#8a5d00;}
    }
  </style>
</head>
<body>
  <h1>ğŸ“± Barcode Scanner Benchmarkï¼ˆZXingå°‚ç”¨ï¼‰</h1>
  <div class="row">
    <label>ã‚«ãƒ¡ãƒ©:<select id="device"></select></label>
    <label>è§£åƒåº¦:
      <select id="preset">
        <option value="480p">854x480 (é«˜é€Ÿ)</option>
        <option value="720p" selected>1280x720 (æ¨™æº–)</option>
        <option value="540p">960x540 (ãƒãƒ©ãƒ³ã‚¹)</option>
      </select>
    </label>
    <span class="pill">EAN-13ï¼ˆæ•™ç§‘æ›¸ISBNï¼‰å°‚ç”¨æœ€é©åŒ–</span>
  </div>
  <div class="row">
    <button id="btnInit">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="btnStart" disabled>ğŸ” èªè­˜é–‹å§‹</button>
    <button id="btnStop" disabled>â¹ï¸ åœæ­¢</button>
    <button id="btnTeardown" disabled>ğŸ—‘ï¸ è§£æ”¾</button>
    <button id="btnExport" disabled>ğŸ“„ CSVå‡ºåŠ›</button>
  </div>
  <div id="status">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚«ãƒ¡ãƒ©ã®æº–å‚™ä¸­...</div>
  <video id="video" playsinline muted></video>
  <div class="note">
    ğŸ“Š <strong>è¨ˆæ¸¬:</strong> èµ·å‹•æ™‚é–“ï¼èªè­˜æ™‚é–“ï¼ˆæœ€åˆã®æ¤œå‡ºã¾ã§ã®æ™‚é–“ï¼‰<br>
    ğŸ“– æ•™ç§‘æ›¸ISBNï¼ˆEAN-13, 978/979ã‹ã‚‰å§‹ã¾ã‚‹13æ¡ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰
  </div>
  <div id="log"></div>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
<script>
const $ = s=>document.querySelector(s);
const video=$("#video"),logView=$("#log"),statusView=$("#status");
let zxingReader=null,scanning=false,currentStream=null;
let t0=0,t1=0,s0=0,s1=0;
const results=[];
function log(...a){logView.textContent+=`[${new Date().toLocaleTimeString()}] `+a.join(" ")+"\n";logView.scrollTop=logView.scrollHeight;}
function setStatus(msg,type="ok"){
  statusView.textContent=msg;
  if(type==="ok")statusView.style.background="#20294D",statusView.style.color="#fff";
  if(type==="warn")statusView.style.background="#ffe29b",statusView.style.color="#1c1200";
  if(type==="error")statusView.style.background="#b22222",statusView.style.color="#fff";
}
function updateButtons(state){
  $("#btnInit").disabled=(state==="scanning");
  $("#btnStart").disabled=!(state==="ready");
  $("#btnStop").disabled=!(state==="scanning");
  $("#btnTeardown").disabled=!(state==="ready"||state==="scanning");
  $("#btnExport").disabled=results.length===0;
}
async function updateDeviceList(){
  try{
    const temp=await navigator.mediaDevices.getUserMedia({video:true});
    temp.getTracks().forEach(t=>t.stop());
    const devs=await navigator.mediaDevices.enumerateDevices();
    const cams=devs.filter(d=>d.kind==="videoinput");
    const sel=$("#device");sel.innerHTML="";
    cams.forEach(cam=>{
      const opt=document.createElement("option");
      opt.value=cam.deviceId;
      opt.textContent=cam.label||`ã‚«ãƒ¡ãƒ©${cam.deviceId.slice(0,8)}`;
      sel.appendChild(opt);
    });
  }catch(e){log("âš ï¸ ã‚«ãƒ¡ãƒ©æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“:",e.message);}
}
function getMediaConstraints(){
  const deviceId=$("#device").value,preset=$("#preset").value;
  const sizes={ "480p":{width:854,height:480}, "540p":{width:960,height:540}, "720p":{width:1280,height:720} };
  const sz=sizes[preset]||sizes["720p"];
  return{audio:false,video:{...(deviceId?{deviceId:{exact:deviceId}}:{facingMode:"environment"}),
  width:{ideal:sz.width},height:{ideal:sz.height},frameRate:{ideal:30}}};
}
function recordMeasurement(data){
  results.push({
    timestamp:new Date().toISOString(),
    device:$("#device").selectedOptions[0]?.textContent||"unknown",
    preset:$("#preset").value,...data
  });
  updateButtons(scanning?"scanning":zxingReader?"ready":"idle");
}
function exportResults(){
  if(results.length===0)return;
  const hd=["timestamp","device","preset","init_time_ms","scan_time_ms","detected_text","format"];
  const csv=[hd.join(","),...results.map(r=>[r.timestamp,`"${r.device}"`,r.preset,
    r.init_time_ms||"",r.scan_time_ms||"",`"${r.detected_text||""}"`,r.format||""].join(","))].join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob),a=document.createElement("a");
  a.href=url;a.download=`barcode_benchmark_${new Date().toISOString().replace(/:/g,"-").slice(0,19)}.csv`;
  a.click();URL.revokeObjectURL(url);log("ğŸ“„çµæœã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰");
}
async function initZXing(){
  if(typeof window.ZXing==="undefined")throw new Error("ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  t0=performance.now();
  const cs=getMediaConstraints();
  currentStream=await navigator.mediaDevices.getUserMedia(cs);
  video.srcObject=currentStream;await video.play();
  const ZX=window.ZXing||ZXing;
  const hints=new Map();
  hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS,[ZX.BarcodeFormat.EAN_13]);
  hints.set(ZX.DecodeHintType.TRY_HARDER,false);
  zxingReader=new ZX.BrowserMultiFormatReader(hints);
  t1=performance.now();
  log(`âœ… ZXingåˆæœŸåŒ–(${(t1-t0).toFixed(1)}ms)`);
  setStatus("ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†","ok");updateButtons("ready");
  recordMeasurement({init_time_ms:(t1-t0).toFixed(1)});
}
async function startZXingScan(){
  if(!zxingReader)return;
  scanning=true;updateButtons("scanning");
  s0=performance.now();
  zxingReader.decodeFromVideoElementContinuously(video,(result,err)=>{
    if(result&&scanning){
      s1=performance.now();
      const text=result.getText(),format=result.getBarcodeFormat();
      log(`ğŸ¯æ¤œå‡º:${text} (${format})`);
      setStatus(`æ¤œå‡ºå®Œäº†:${text}`,"ok");
      recordMeasurement({scan_time_ms:(s1-s0).toFixed(1),detected_text:text,format});
      stopZXingScan();
    }
  });setStatus("ã‚¹ã‚­ãƒ£ãƒ³ä¸­...ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„","warn");
}
async function stopZXingScan(){
  if(zxingReader)zxingReader.reset();
  scanning=false;setStatus("åœæ­¢ã—ã¾ã—ãŸ","ok");updateButtons("ready");
}
async function cleanupZXing(){
  await stopZXingScan();
  if(zxingReader)zxingReader=null;
  if(currentStream){currentStream.getTracks().forEach(t=>t.stop());currentStream=null;}
  video.srcObject=null;setStatus("è§£æ”¾å®Œäº†","ok");updateButtons("idle");
}
$("#btnInit").onclick=async()=>{try{await cleanupZXing();log("ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–‹å§‹");await initZXing();}catch(e){log("âŒåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",e.message);setStatus("åˆæœŸåŒ–å¤±æ•—","error");}};
$("#btnStart").onclick=async()=>{try{await startZXingScan();}catch(e){log("âŒèªè­˜ã‚¨ãƒ©ãƒ¼:",e.message);setStatus("èªè­˜å¤±æ•—","error");}};
$("#btnStop").onclick=async()=>{await stopZXingScan();};
$("#btnTeardown").onclick=async()=>{await cleanupZXing();};
$("#btnExport").onclick=exportResults;
window.addEventListener('load',async()=>{
  try{await updateDeviceList();setStatus("ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆOK - èµ·å‹•ã§ãã¾ã™","ok");
  log("æº–å‚™å®Œäº†: ã‚«ãƒ¡ãƒ©é¸æŠâ†’èµ·å‹•â†’èªè­˜é–‹å§‹");updateButtons("idle");}
  catch(e){log("âŒ èµ·å‹•ã‚¨ãƒ©ãƒ¼:",e.message);setStatus("èµ·å‹•ã‚¨ãƒ©ãƒ¼","error");}
});
</script>
</body>
</html>
