<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Barcode Scanner Benchmark - ZXingå°‚ç”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ZXing (æœ€æ–°ç‰ˆ) CDN -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen transition-colors">
  <div class="max-w-lg mx-auto p-6 space-y-6">
    <h1 class="text-2xl font-bold flex items-center gap-2">ğŸ“± Barcode Scanner Performance Benchmark</h1>
    <div class="flex flex-wrap gap-4 items-center">
      <div>
        <label class="block font-medium mb-1">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</label>
        <span class="inline-flex items-center px-3 py-1 bg-gray-200 dark:bg-gray-700 text-sm rounded">ZXingï¼ˆæœ€æ–°ç‰ˆãƒ»é«˜é€Ÿãƒ»æ¨å¥¨ï¼‰</span>
      </div>
      <div>
        <label class="block font-medium mb-1" for="device">ã‚«ãƒ¡ãƒ©</label>
        <select id="device" class="block w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2"></select>
      </div>
      <div>
        <label class="block font-medium mb-1" for="preset">è§£åƒåº¦</label>
        <select id="preset" class="block w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2">
          <option value="480p">854x480 (é«˜é€Ÿ)</option>
          <option value="720p" selected>1280x720 (æ¨™æº–)</option>
          <option value="540p">960x540 (ãƒãƒ©ãƒ³ã‚¹)</option>
        </select>
      </div>
      <span class="inline-flex items-center bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-200 text-indigo-800 rounded-full px-3 py-1 text-xs font-semibold">ğŸ“š æ•™ç§‘æ›¸ISBN(EAN-13)æœ€é©åŒ–æ¸ˆã¿</span>
    </div>
    <div class="flex gap-3 mt-2">
      <button id="btnInit"     class="tw-btn-primary">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="btnStart"    class="tw-btn-primary" disabled>ğŸ” èªè­˜é–‹å§‹</button>
      <button id="btnStop"     class="tw-btn-secondary" disabled>â¹ï¸ åœæ­¢</button>
      <button id="btnTeardown" class="tw-btn-secondary" disabled>ğŸ—‘ï¸ è§£æ”¾</button>
      <button id="btnExport"   class="tw-btn-success" disabled>ğŸ“„ CSVå‡ºåŠ›</button>
    </div>
    <div id="status" class="p-3 rounded text-sm font-semibold bg-blue-100 dark:bg-blue-900 dark:text-blue-200 text-blue-800">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ä¸­...</div>
    <video id="video" class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-black aspect-video" playsinline muted></video>
    <div class="text-sm text-gray-600 dark:text-gray-300">
      ğŸ“Š <strong>è¨ˆæ¸¬é …ç›®:</strong><br>
      ãƒ»èµ·å‹•æ™‚é–“: ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–å®Œäº†ã¾ã§ã®æ™‚é–“<br>
      ãƒ»èªè­˜æ™‚é–“: ã€Œèªè­˜é–‹å§‹ã€â†’æœ€åˆã®æ¤œå‡ºã¾ã§ã®æ™‚é–“<br>
      ğŸ“– <strong>å¯¾è±¡:</strong> æ•™ç§‘æ›¸ã«ã‚ˆãã‚ã‚‹ISBNï¼ˆEAN-13ã€978/979ã§å§‹ã¾ã‚‹13æ¡ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰<br>
      ğŸ’¡ <span class="font-semibold text-indigo-600 dark:text-indigo-300">ZXing ãŒæœ€ã‚‚é«˜é€Ÿãƒ»å®‰å®šã§ã™</span>
    </div>
    <pre id="log" class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 min-h-[120px] max-h-[300px] overflow-y-auto text-xs"></pre>
  </div>
  <style>
    /* Tailwind ãƒœã‚¿ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .tw-btn-primary { @apply px-3 py-2 rounded text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 transition; }
    .tw-btn-secondary { @apply px-3 py-2 rounded text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:bg-gray-500 transition; }
    .tw-btn-success { @apply px-3 py-2 rounded text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-500 transition; }
  </style>
  <script>
    // Utility
    const $ = s => document.querySelector(s);
    const video = $("#video");
    const logView = $("#log");
    const statusView = $("#status");
    const btnInit = $("#btnInit");
    const btnStart = $("#btnStart");
    const btnStop = $("#btnStop");
    const btnTeardown = $("#btnTeardown");
    const btnExport = $("#btnExport");
    let currentAdapter = null;
    let currentStream = null;
    let t0 = 0, t1 = 0, s0 = 0, s1 = 0;
    let deviceListUpdating = false;
    const results = [];

    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿã™ã‚‹é–¢æ•°
    async function waitForZXingLibrary(maxWait = 5000) {
      const start = Date.now();
      while (typeof window.ZXing === 'undefined') {
        if (Date.now() - start > maxWait) {
          throw new Error('ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        }
        await new Promise(r => setTimeout(r, 50));
      }
    }

    // â˜… å¤§å¹…æ”¹å–„ï¼šç¢ºå®Ÿãªãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ æº–å‚™å®Œäº†å¾…æ©Ÿ
    async function waitForVideoReady(videoElement, maxWait = 15000) {
      const startTime = Date.now();

      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error(`ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ æº–å‚™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (${maxWait}ms)`));
        }, maxWait);

        const checkConditions = () => {
          const elapsed = Date.now() - startTime;

          // è¤‡æ•°ã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
          const hasMetadata = videoElement.readyState >= 2;
          const hasDimensions = videoElement.videoWidth > 0 && videoElement.videoHeight > 0;
          const isPlaying = !videoElement.paused && !videoElement.ended && videoElement.currentTime > 0;

          log(`ğŸ” ãƒ“ãƒ‡ã‚ªçŠ¶æ…‹ç¢ºèª [${elapsed}ms]: readyState=${videoElement.readyState}, size=${videoElement.videoWidth}x${videoElement.videoHeight}, playing=${isPlaying}`);

          // å…¨æ¡ä»¶ãŒæƒã£ãŸå ´åˆ
          if (hasMetadata && hasDimensions && isPlaying) {
            clearTimeout(timeout);
            log(`âœ… ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ æº–å‚™å®Œäº† (${elapsed}ms)`);
            resolve();
            return;
          }

          // ã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯100mså¾Œã«å†ãƒã‚§ãƒƒã‚¯
          setTimeout(checkConditions, 100);
        };

        // å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
        const events = ['loadedmetadata', 'loadeddata', 'canplay', 'playing', 'resize'];
        const cleanup = () => {
          events.forEach(event => {
            videoElement.removeEventListener(event, checkConditions);
          });
        };

        events.forEach(event => {
          videoElement.addEventListener(event, checkConditions, { once: true });
        });

        // åˆå›ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        checkConditions();

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨
        timeout._cleanup = cleanup;
      });
    }

    // æ”¹å–„ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–¢æ•°
    async function initializeCamera() {
      log('ğŸ¥ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–é–‹å§‹...');

      // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç¢ºå®Ÿã«åœæ­¢
      if (currentStream) {
        log('ğŸ›‘ æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ä¸­...');
        currentStream.getTracks().forEach(track => {
          track.stop();
          track.enabled = false;
        });
        currentStream = null;
        video.srcObject = null;
        await new Promise(r => setTimeout(r, 500)); // ã‚ˆã‚Šé•·ã„å¾…æ©Ÿæ™‚é–“
      }

      const constraints = getMediaConstraints();
      log('ğŸ“‹ ãƒ¡ãƒ‡ã‚£ã‚¢åˆ¶ç´„:', JSON.stringify(constraints, null, 2));

      // ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      log('ğŸ“¡ ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—å®Œäº†');

      // ãƒ“ãƒ‡ã‚ªè¦ç´ ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®š
      video.srcObject = currentStream;

      // å†ç”Ÿé–‹å§‹
      await safePlayVideo(video);
      log('â–¶ï¸ ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹');

      // â˜… é‡è¦ï¼šç¢ºå®Ÿã«ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
      await waitForVideoReady(video);

      log(`ğŸ“º æœ€çµ‚ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${video.videoWidth}x${video.videoHeight}`);
    }

    // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼šZXingå°‚ç”¨ï¼ˆä¿®æ­£ç‰ˆï¼‰
    const ZXingAdapter = {
      reader: null,
      scanning: false,
      async init() {
        if (typeof window.ZXing === 'undefined') {
          throw new Error('ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/CORS/CDNç­‰ã‚’ç¢ºèªï¼‰');
        }

        t0 = performance.now();

        // æ”¹å–„ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚’ä½¿ç”¨
        await initializeCamera();

        const hints = new Map();
        hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [window.ZXing.BarcodeFormat.EAN_13]);
        hints.set(window.ZXing.DecodeHintType.TRY_HARDER, false);

        // ãƒªãƒ¼ãƒ€ãƒ¼ä½œæˆ
        this.reader = new window.ZXing.BrowserMultiFormatReader(hints);
        log('ğŸ”§ ZXingãƒªãƒ¼ãƒ€ãƒ¼ä½œæˆå®Œäº†');

        // ãƒªãƒ¼ãƒ€ãƒ¼ã®å‹•ä½œç¢ºèª
        await this.verifyReaderFunction();

        t1 = performance.now();
        log(`âœ… ZXingåˆæœŸåŒ–å®Œäº† (${(t1-t0).toFixed(1)}ms) - EAN-13ç‰¹åŒ–ãƒ¢ãƒ¼ãƒ‰`);
      },

      // â˜… ãƒªãƒ¼ãƒ€ãƒ¼å‹•ä½œç¢ºèª
      async verifyReaderFunction() {
        try {
          // çŸ­æ™‚é–“ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§å‹•ä½œç¢ºèª
          let testCompleted = false;
          const testPromise = new Promise((resolve) => {
            const testTimeout = setTimeout(() => {
              this.reader.reset();
              testCompleted = true;
              resolve();
            }, 500);

            this.reader.decodeFromVideoElementContinuously(video, (result, error) => {
              if (!testCompleted) {
                clearTimeout(testTimeout);
                this.reader.reset();
                testCompleted = true;
                resolve();
              }
            });
          });

          await testPromise;
          log('âœ”ï¸ ZXingãƒªãƒ¼ãƒ€ãƒ¼å‹•ä½œç¢ºèªå®Œäº†');
        } catch (error) {
          throw new Error(`ãƒªãƒ¼ãƒ€ãƒ¼å‹•ä½œç¢ºèªå¤±æ•—: ${error.message}`);
        }
      },

      async startScan(onDetected) {
        if (this.scanning || !this.reader) return;

        // â˜… ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹å‰ã®æœ€çµ‚ç¢ºèª
        if (!video.videoWidth || !video.videoHeight) {
          throw new Error(`ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ (${video.videoWidth}x${video.videoHeight})`);
        }

        this.scanning = true;
        s0 = performance.now();

        log(`ğŸ” ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ - ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${video.videoWidth}x${video.videoHeight}`);

        this.reader.decodeFromVideoElementContinuously(video, (result, err) => {
          if (result && this.scanning) {
            s1 = performance.now();
            const text = result.getText();
            const format = result.getBarcodeFormat();
            const isISBN = /^97[89]\d{10}$/.test(text);
            log(`ğŸ¯ æ¤œå‡º: ${text} ${isISBN ? 'ğŸ“š(ISBN)' : 'ğŸ“¦(ä¸€èˆ¬EAN)'}`);
            onDetected({ text, format, isISBN });
            this.stopScan();
          }
        });
      },

      async stopScan() {
        this.reader && this.reader.reset();
        this.scanning = false;
      },

      async cleanup() {
        await this.stopScan();
        this.reader = null;
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }
        video.srcObject = null;
      }
    };

    // å…±é€šUIãƒ»ãƒ­ã‚¸ãƒƒã‚¯
    function log(...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.join(" ");
      logView.textContent += `[${timestamp}] ${message}\n`;
      logView.scrollTop = logView.scrollHeight;
      console.log(...args);
    }

    function setStatus(message, color="blue") {
      const map = {
        blue: { bg: 'bg-blue-100 dark:bg-blue-900 dark:text-blue-200 text-blue-800' },
        green: { bg: 'bg-green-100 dark:bg-green-900 dark:text-green-200 text-green-800' },
        yellow: { bg: 'bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-200 text-yellow-800' },
        red: { bg: 'bg-red-100 dark:bg-red-900 dark:text-red-200 text-red-800' }
      };
      statusView.className = "p-3 rounded text-sm font-semibold " + (map[color]?.bg || map.blue.bg);
      statusView.textContent = message;
    }

    function updateButtons(state) {
      const enable = (b, v) => b.disabled = !v;
      if (state === 'idle') {
        enable(btnInit, true); enable(btnStart, false); enable(btnStop, false); enable(btnTeardown, false); enable(btnExport, results.length);
      } else if (state === 'ready') {
        enable(btnInit, false); enable(btnStart, true); enable(btnStop, false); enable(btnTeardown, true); enable(btnExport, results.length);
      } else if (state === 'scanning') {
        enable(btnInit, false); enable(btnStart, false); enable(btnStop, true); enable(btnTeardown, false); enable(btnExport, true);
      }
    }

    function getMediaConstraints() {
      const deviceId = $("#device").value;
      const preset = $("#preset").value;
      const resolutions = {
        "480p": {width:854, height:480},
        "540p": {width:960, height:540},
        "720p": {width:1280, height:720}
      };
      const res = resolutions[preset] || resolutions["720p"];
      return {
        audio: false,
        video: {
          ...(deviceId ? {deviceId:{exact:deviceId}} : {facingMode:"environment"}),
          width: {ideal: res.width},
          height: {ideal: res.height},
          frameRate: {ideal: 30}
        }
      };
    }

    async function safePlayVideo(videoElement) {
      try {
        await videoElement.play();
        log('â–¶ï¸ ãƒ“ãƒ‡ã‚ªå†ç”ŸæˆåŠŸ');
      } catch (error) {
        if (error.name !== 'AbortError') {
          log('âš ï¸ ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼:', error.message);
          throw error;
        }
      }
    }

    // æ”¹å–„ã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆæ›´æ–°é–¢æ•°
    async function updateDeviceList() {
      if (deviceListUpdating) return;
      deviceListUpdating = true;

      try {
        const tempStream = await navigator.mediaDevices.getUserMedia({video: true});
        tempStream.getTracks().forEach(track => track.stop());

        await new Promise(r => setTimeout(r, 100));

        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(d => d.kind==="videoinput");
        const select = $("#device");
        select.innerHTML = "";

        cameras.forEach(camera => {
          const option = document.createElement("option");
          option.value = camera.deviceId;
          option.textContent = camera.label || `ã‚«ãƒ¡ãƒ© ${camera.deviceId.slice(0,8)}`;
          select.appendChild(option);
        });

        log(`${cameras.length ? `ğŸ“· ${cameras.length}å°ã®ã‚«ãƒ¡ãƒ©ã‚’æ¤œå‡º`: "âš ï¸ ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"}`);
      } catch (e) {
        log("âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ã§ã™:", e.message);
      } finally {
        deviceListUpdating = false;
      }
    }

    function recordMeasurement(data) {
      const record = {
        timestamp: new Date().toISOString(),
        library: "zxing",
        device: $("#device").selectedOptions[0]?.textContent || "unknown",
        preset: $("#preset").value,
        ...data
      };
      results.push(record);
      updateButtons(currentAdapter ? "ready" : "idle");
    }

    function exportResults() {
      if (!results.length) {
        log("âš ï¸ å‡ºåŠ›å¯èƒ½ãªçµæœãŒã‚ã‚Šã¾ã›ã‚“"); return;
      }
      const headers = ["timestamp","library","device","preset","init_time_ms","scan_time_ms","detected_text","format","is_isbn"];
      const csv = [
        headers.join(","),
        ...results.map(r => [
          r.timestamp,
          r.library,
          `"${r.device}"`,
          r.preset,
          r.init_time_ms||"",
          r.scan_time_ms||"",
          `"${r.detected_text||""}"`,
          r.format||"",
          r.is_isbn||false
        ].join(","))
      ].join("\n");
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `barcode_benchmark_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      log(`ğŸ“„ ${results.length}ä»¶ã®çµæœã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    btnInit.onclick = async () => {
      try {
        setStatus("ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...", "yellow");
        updateButtons("idle");
        if (currentAdapter) {
          await currentAdapter.cleanup();
        }
        currentAdapter = ZXingAdapter;
        t0=t1=s0=s1=0;
        await currentAdapter.init();
        setStatus("ZXingã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº† - èªè­˜é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„", "green");
        updateButtons("ready");
        recordMeasurement({init_time_ms:(t1-t0).toFixed(1),scan_time_ms:"",detected_text:"",format:"",is_isbn:false});
      } catch (e) {
        log("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e.message);
        setStatus("åˆæœŸåŒ–å¤±æ•— - ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„", "red");
        updateButtons("idle");
      }
    };

    btnStart.onclick = async () => {
      if (!currentAdapter) return;
      try {
        setStatus("ğŸ“± ã‚¹ã‚­ãƒ£ãƒ³ä¸­ - ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„", "yellow");
        updateButtons("scanning");
        s0=s1=0;
        await currentAdapter.startScan((result) => {
          const scanTime = s1-s0;
          log(`âš¡ èªè­˜å®Œäº†: ${scanTime.toFixed(1)}ms ã§æ¤œå‡º`);
          setStatus(`âœ… æ¤œå‡ºå®Œäº†: ${result.text}`, "green");
          updateButtons("ready");
          recordMeasurement({
            init_time_ms: (t1-t0).toFixed(1),
            scan_time_ms: scanTime.toFixed(1),
            detected_text: result.text,
            format: result.format,
            is_isbn: result.isISBN||false
          });
        });
      } catch (e) {
        log("âŒ ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:", e.message);
        setStatus("ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—", "red");
        updateButtons("ready");
      }
    };

    btnStop.onclick = async () => {
      if (currentAdapter) {
        await currentAdapter.stopScan();
        setStatus("ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢", "blue");
        updateButtons("ready");
        log("â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ");
      }
    };

    btnTeardown.onclick = async () => {
      if (currentAdapter) {
        await currentAdapter.cleanup();
        currentAdapter = null;
        setStatus("è§£æ”¾å®Œäº† - æ–°ã—ã„ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™", "blue");
        updateButtons("idle");
        log("ğŸ—‘ï¸ ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã—ã¾ã—ãŸ");
      }
    };

    btnExport.onclick = exportResults;

    window.addEventListener('load', async () => {
      try {
        await waitForZXingLibrary();
        await updateDeviceList();
        log("ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†");
        log("ğŸ“– ä½¿ç”¨æ–¹æ³•: 1.ã‚«ãƒ¡ãƒ©é¸æŠ 2.è§£åƒåº¦é¸æŠ 3.ã‚«ãƒ¡ãƒ©èµ·å‹• â†’ èªè­˜é–‹å§‹");
        log("ğŸ“š ISBNå¯¾å¿œ: 978/979ã§å§‹ã¾ã‚‹13æ¡ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã™");
        setStatus("æº–å‚™å®Œäº† - ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„", "blue");
        updateButtons("idle");
      } catch (e) {
        log("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e.message); 
        setStatus("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ - ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„", "red");
      }
    });
  </script>
</body>
</html>
