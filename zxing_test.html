<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Barcode Scanner Benchmark - ZXing æœ€æ–°å°‚ç”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; color: #222; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
    label { display: inline-flex; align-items: center; gap: 6px; }
    select, button { font: inherit; padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #007bff; color: white; border: none; transition: background 0.2s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed;}
    #video { width: min(480px, 90vw); aspect-ratio: 4 / 3; background: #000; border-radius: 8px; display: block; }
    #status {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      margin-bottom: 10px;
      background: #263953;
      color: #fff;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #0002;
      border: 1px solid #445577;
      font-size: 1.12em;
    }
    #log {
      margin-top: 12px; padding: 14px;
      border: 1px solid #222;
      border-radius: 8px;
      background: #11192d;
      color: #F8F8FF;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      min-height: 120px;
      max-height: 320px;
      overflow-y: auto;
      font-size: 16px;
      transition: background 0.3s,color 0.3s;
    }
    .note { font-size: 13px; color: #666; margin: 12px 0 0 0; }
    .pill {
      padding: 2px 8px; border-radius: 12px;
      background: #eee1ae; color: #774c00; font-size: 12px; font-weight: bold;
    }
    @media (prefers-color-scheme: dark) {
      body { background: #161e2e; color: #e8e8f8; }
      input, select, button { background: #222f48; color: #e8e8f8; }
      button { color: #fff;}
      #video { border-color: #334; }
      #log { background: #181d38; color: #dcf0ff; border-color: #3af;}
      #status { background: #223; color: #fff; border: 1px solid #55a; }
      .pill { background: #222f48; color: #eed167; }
    }
  </style>
</head>
<body>
  <h1>ğŸ“± Barcode Scanner Benchmarkï¼ˆZXingå°‚ç”¨ æœ€é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰</h1>
  <div class="row">
    <label>ã‚«ãƒ¡ãƒ©:
      <select id="device"></select>
    </label>
    <label>è§£åƒåº¦:
      <select id="preset">
        <option value="480p">854x480 (é«˜é€Ÿ)</option>
        <option value="720p" selected>1280x720 (æ¨™æº–)</option>
        <option value="540p">960x540 (ãƒãƒ©ãƒ³ã‚¹)</option>
      </select>
    </label>
    <span class="pill">EAN-13ï¼ˆæ•™ç§‘æ›¸ISBNï¼‰å°‚ç”¨æœ€é©åŒ–</span>
  </div>
  <div class="row">
    <button id="btnInit">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="btnStart" disabled>ğŸ” èªè­˜é–‹å§‹</button>
    <button id="btnStop" disabled>â¹ï¸ åœæ­¢</button>
    <button id="btnTeardown" disabled>ğŸ—‘ï¸ è§£æ”¾</button>
    <button id="btnExport" disabled>ğŸ“„ CSVå‡ºåŠ›</button>
  </div>
  <div id="status">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚«ãƒ¡ãƒ©ã®æº–å‚™ä¸­...</div>
  <video id="video" playsinline muted></video>
  <div class="note">
    ğŸ“Š <strong>è¨ˆæ¸¬é …ç›®:</strong><br>
    ãƒ»èµ·å‹•æ™‚é–“: ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–å®Œäº†ã¾ã§ã®æ™‚é–“<br>
    ãƒ»èªè­˜æ™‚é–“: ã€Œèªè­˜é–‹å§‹ã€â†’æœ€åˆã®æ¤œå‡ºã¾ã§ã®æ™‚é–“<br>
    ğŸ“– <strong>å¯¾è±¡:</strong> æ•™ç§‘æ›¸ã«ã‚ˆãã‚ã‚‹ISBNï¼ˆEAN-13ã€978/979ã‹ã‚‰å§‹ã¾ã‚‹13æ¡ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰
  </div>
  <div id="log"></div>

  <!-- ZXing æœ€æ–° (Browser 0.5.13 ã‚‚å¯/æ¨å¥¨) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
  <script>
    // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
    const $ = (s) => document.querySelector(s);
    const video = $("#video");
    const logView = $("#log");
    const statusView = $("#status");
    const btnInit = $("#btnInit");  const btnStart = $("#btnStart");
    const btnStop = $("#btnStop");  const btnTeardown = $("#btnTeardown");
    const btnExport = $("#btnExport");

    let zxingReader = null;
    let scanning = false;
    let currentStream = null;
    let t0 = 0, t1 = 0, s0 = 0, s1 = 0;
    const results = [];

    // ãƒ­ã‚°
    const log = (...args) => {
      const timestamp = new Date().toLocaleTimeString();
      const msg = args.join(" ");
      logView.textContent += `[${timestamp}] ${msg}\n`;
      logView.scrollTop = logView.scrollHeight;
      console.log(...args);
    };

    const setStatus = (msg, type="ok") => {
      statusView.textContent = msg;
      if(type==="ok") statusView.style.background = "#263953", statusView.style.color="#fff";
      if(type==="warn") statusView.style.background = "#ebcf7c", statusView.style.color="#222";
      if(type==="error") statusView.style.background = "#b22222", statusView.style.color="#fff";
    };

    const updateButtons = (state) => {
      btnInit.disabled   = state === "scanning";
      btnStart.disabled  = !(state === "ready");
      btnStop.disabled   = !(state === "scanning");
      btnTeardown.disabled = !(state === "ready" || state === "scanning");
      btnExport.disabled = results.length === 0;
    };

    async function updateDeviceList() {
      try {
        // ãƒ©ãƒ™ãƒ«å–å¾—ç›®çš„ã®æ¨©é™å–å¾—
        const temp = await navigator.mediaDevices.getUserMedia({ video: true });
        temp.getTracks().forEach(t => t.stop());
        const devs = await navigator.mediaDevices.enumerateDevices();
        const cameras = devs.filter(d => d.kind === "videoinput");
        const select = $("#device");
        select.innerHTML = "";
        cameras.forEach(cam => {
          const opt = document.createElement("option");
          opt.value = cam.deviceId;
          opt.textContent = cam.label || `ã‚«ãƒ¡ãƒ© ${cam.deviceId.slice(0,8)}`;
          select.appendChild(opt);
        });
        if (cameras.length === 0) log("âš ï¸ ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      } catch (e) {
        log("âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“:", e.message);
      }
    }

    function getMediaConstraints() {
      const deviceId = $("#device").value;
      const preset = $("#preset").value;
      const resMap = {
        "480p": { width: 854, height: 480 },
        "540p": { width: 960, height: 540 },
        "720p": { width: 1280, height: 720 }
      };
      const res = resMap[preset] || resMap["720p"];
      return {
        audio: false,
        video: {
          ...(deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment" }),
          width: { ideal: res.width }, height: { ideal: res.height },
          frameRate: { ideal: 30 }
        }
      };
    }

    function recordMeasurement(data) {
      results.push({
        timestamp: new Date().toISOString(),
        device: $("#device").selectedOptions[0]?.textContent || "unknown",
        preset: $("#preset").value,
        ...data
      });
      updateButtons(scanning ? "scanning" : zxingReader ? "ready" : "idle");
    }

    function exportResults() {
      if(results.length===0)return;
      const headers = ["timestamp","device","preset","init_time_ms","scan_time_ms","detected_text","format"];
      const csv = [
        headers.join(","),
        ...results.map(r => [
          r.timestamp,
          `"${r.device}"`,
          r.preset,
          r.init_time_ms||"",
          r.scan_time_ms||"",
          `"${r.detected_text||""}"`,
          r.format||""
        ].join(","))
      ].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `barcode_benchmark_${new Date().toISOString().replace(/:/g,"-").slice(0,19)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      log("ğŸ“„ çµæœã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
    }

    // ZXingå°‚ç”¨
    async function initZXing() {
      if (typeof window.ZXing === 'undefined') throw new Error("ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
      t0 = performance.now();
      const constraints = getMediaConstraints();
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = currentStream;
      await video.play();

      // æœ€æ–°ç‰ˆã§ã¯ window.ZXing or ZXing ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
      const ZX = window.ZXing || ZXing;
      const hints = new Map();
      hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [ZX.BarcodeFormat.EAN_13]);
      hints.set(ZX.DecodeHintType.TRY_HARDER, false);
      zxingReader = new ZX.BrowserMultiFormatReader(hints);

      t1 = performance.now();
      log(`âœ… ZXingåˆæœŸåŒ–å®Œäº† (${(t1-t0).toFixed(1)}ms)`);
      setStatus("ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†", "ok");
      updateButtons("ready");
      recordMeasurement({ init_time_ms: (t1-t0).toFixed(1) });
    }

    async function startZXingScan() {
      if (!zxingReader) return;
      scanning = true;
      updateButtons("scanning");
      s0 = performance.now();
      zxingReader.decodeFromVideoElementContinuously(video, (result, err) => {
        if (result && scanning) {
          s1 = performance.now();
          const text = result.getText();
          const format = result.getBarcodeFormat();
          log(`ğŸ¯æ¤œå‡º: ${text} (${format})`);
          setStatus(`æ¤œå‡ºå®Œäº†: ${text}`, "ok");
          recordMeasurement({
            scan_time_ms: (s1-s0).toFixed(1),
            detected_text: text,
            format
          });
          stopZXingScan();
        }
      });
      setStatus("ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„", "warn");
    }

    async function stopZXingScan() {
      if (zxingReader) zxingReader.reset();
      scanning = false;
      setStatus("åœæ­¢ã—ã¾ã—ãŸ", "ok");
      updateButtons("ready");
    }

    async function cleanupZXing() {
      await stopZXingScan();
      if (zxingReader) zxingReader = null;
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      video.srcObject = null;
      setStatus("è§£æ”¾å®Œäº†", "ok");
      updateButtons("idle");
    }

    // === ã‚¤ãƒ™ãƒ³ãƒˆ
    btnInit.onclick = async () => {
      try {
        await cleanupZXing();
        log("ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™");
        await initZXing();
      } catch (e) {
        log("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e.message);
        setStatus("åˆæœŸåŒ–å¤±æ•—", "error");
      }
    };
    btnStart.onclick = async () => {
      try { await startZXingScan(); }
      catch (e) {
        log("âŒ èªè­˜ã‚¨ãƒ©ãƒ¼:", e.message);
        setStatus("èªè­˜å¤±æ•—", "error");
      }
    };
    btnStop.onclick = async () => { await stopZXingScan(); };
    btnTeardown.onclick = async () => { await cleanupZXing(); };
    btnExport.onclick = exportResults;

    // === åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      try {
        await updateDeviceList();
        setStatus("ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆOK - èµ·å‹•ã§ãã¾ã™", "ok");
        log("ğŸš€ æº–å‚™å®Œäº†: ã‚«ãƒ¡ãƒ©ã‚’é¸æŠâ†’ã‚«ãƒ¡ãƒ©èµ·å‹•â†’èªè­˜é–‹å§‹");
        updateButtons("idle");
      } catch (e) {
        log("âŒ èµ·å‹•ã‚¨ãƒ©ãƒ¼:", e.message);
        setStatus("èµ·å‹•ã‚¨ãƒ©ãƒ¼", "error");
      }
    });
  </script>
</body>
</html>
